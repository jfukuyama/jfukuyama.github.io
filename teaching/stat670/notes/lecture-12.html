<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Julia Fukuyama" />
  <title>Stat 470/670 Lecture 12: More interactions, coplots, and modeling</title>
  <style type="text/css">
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" type="text/css" media="screen, projection, print"
    href="https://www.w3.org/Talks/Tools/Slidy2/styles/slidy.css" />
  <script
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js"
  type="text/javascript"></script>
  <script src="https://www.w3.org/Talks/Tools/Slidy2/scripts/slidy.js"
    charset="utf-8" type="text/javascript"></script>
</head>
<body>
<div class="slide titlepage">
  <h1 class="title">Stat 470/670 Lecture 12: More interactions, coplots,
and modeling</h1>
  <p class="author">
Julia Fukuyama
  </p>
</div>
<div id="today-building-and-checking-models-with-trivariate-data"
class="slide section level2">
<h1>Today: building and checking models with trivariate data</h1>
</div>
<div id="modifying-loess-for-two-predictor-variables"
class="slide section level2">
<h1>Modifying LOESS for two predictor variables</h1>
<p>Now we have a response variable <span
class="math inline">\(y\)</span>, a predictor variable <span
class="math inline">\(x = (u, v)\)</span>, and <span
class="math inline">\(n\)</span> samples.</p>
<p>The parameters are still:</p>
<ul>
<li><span class="math inline">\(\alpha\)</span>: The span, controls the
fraction of points that contribute to the local fit.</li>
</ul>
<ul>
<li><span class="math inline">\(\lambda\)</span>: The degree of the
local fit, usually <span class="math inline">\(1\)</span>, corresponding
to a locally linear fit, or <span class="math inline">\(2\)</span>,
corresponding to a local quadratic fit.</li>
</ul>
</div>
<div class="slide section level2">

<p>Suppose <span class="math inline">\(\lambda = 1\)</span></p>
<p>To find the value of the LOESS smoother at a point <span
class="math inline">\(x_0 = (u_0, v_0)\)</span>, we solve for the
coefficients in the weighted regression problem <span
class="math display">\[
(\hat \beta_0, \hat \beta_1, \hat \beta_2) = \text{argmin}_{
\beta_0,  \beta_1,  \beta_2} \sum_{i=1}^n w_i(x_0) (y_i - ( \beta_0
+  \beta_1 u_i +  \beta_2 v_i ))^2,
\]</span></p>
<p>The value of the LOESS smoother at <span
class="math inline">\(x_0\)</span> is then <span
class="math inline">\(\hat \beta_0 + \hat \beta_1 u_0 + \hat \beta_2
v_0\)</span>.</p>
</div>
<div class="slide section level2">

<p>If <span class="math inline">\(\lambda = 2\)</span>, to find the
value of the LOESS smoother at a point <span class="math inline">\(x_0 =
(u_0, v_0)\)</span>, we solve for the coefficients in the weighted
regression problem <span class="math display">\[
(\hat \beta_0, \hat \beta_1, \hat \beta_2, \hat \beta_3, \hat \beta_4,
\hat \beta_5) = \text{min}_{
\beta_0,  \beta_1,  \beta_2,  \beta_3,  \beta_4,  \beta_5} \sum_{i=1}^n
w_i(x_0) (y_i - ( \beta_0 +  \beta_1 u_i +  \beta_2 v_i +  \beta_3 u_i
v_i +  \beta_4 u_i^2 +  \beta_5 v_i^2))^2,
\]</span></p>
<p>The value of the LOESS smoother at <span
class="math inline">\(x_0\)</span> is then <span
class="math inline">\(\hat \beta_0 + \hat \beta_1 u_0 + \hat \beta_2 v_i
+ \hat \beta_3 u_0 v_0 + \hat \beta_4 u_0^2 + \hat \beta_5
v_0^2\)</span>.</p>
</div>
<div id="weights-for-loess-with-two-predictors"
class="slide section level2">
<h1>Weights for LOESS with two predictors</h1>
<p>The weights are: <span class="math display">\[
w_i(x_0) = T(\Delta_i(x_0) / \Delta_{(q)}(x_0))
\]</span> with</p>
<ul>
<li><span class="math inline">\(\Delta_i(x_0) = \sqrt{(u_i - u_0)^2 +
(v_i - v_0)^2}\)</span></li>
</ul>
<ul>
<li><span class="math inline">\(\Delta_{(i)}(x_0)\)</span> are the
ordered values of <span
class="math inline">\(\Delta_{i}(x_0)\)</span></li>
</ul>
<ul>
<li><span class="math inline">\(q = \alpha n\)</span>, rounded to the
nearest integer.</li>
</ul>
<div class="incremental">
<p>Since the two predictor variables are potentially on different
scales, they are usually normalized using a robust estimate of the
spread before the distances are computed. Some options</p>
<ul>
<li>Median absolute deviation.</li>
</ul>
<ul>
<li>Trimmed standard deviation.</li>
</ul>
<p>Cleveland suggests using a 10% trimmed standard deviation as the
measure of spread for normalization.</p>
</div>
</div>
<div id="a-useful-modification-of-loess" class="slide section level2">
<h1>A useful modification of LOESS</h1>
<p>What if we think some of the conditional relations are from a
parametric family? For example, the dependence of NOx on C seems to
always be linear, no matter what value of E we look at.</p>
<p>We can modify LOESS so that it fits some of the conditional relations
globally instead of locally.</p>
<div class="incremental">
<p>Let <span class="math inline">\(\hat g(u,v)\)</span> be our fitted
LOESS surface, and suppose we want <span class="math inline">\(\hat g(u,
v)\)</span>, seen as a function of <span
class="math inline">\(u\)</span>, to be from a parametric family
(e.g. linear or quadratic).</p>
<p>To do this, we simply drop the <span
class="math inline">\(u_i\)</span>’s from our distances when computing
the weights.</p>
<p>Suppose we want to modify locally linear LOESS in this way. To find
the value of the LOESS smoother at a point <span
class="math inline">\(x_0\)</span>, we find <span
class="math inline">\(\hat \beta_0, \hat \beta_1, \hat \beta_2, \hat
\beta_3\)</span> as <span class="math display">\[
(\hat \beta_0, \hat \beta_1, \hat \beta_2, \hat \beta_3) =
\text{argmin}_{\beta_0, \beta_1, \beta_2, \beta_3} \sum_{i=1}^n w_i(x_0)
(y_i - ( \beta_0 +  \beta_1 u_i +  \beta_2 v_i +  \beta_3 u_i v_i))^2
\]</span> where the weights <span
class="math inline">\(w_i(x_0)\)</span> only take into account the <span
class="math inline">\(v\)</span> coordinates.</p>
<p>The fitted value of the LOESS smoother at <span
class="math inline">\(x_0\)</span>, <span class="math inline">\(\hat
g(x_0) = \hat g(u_0, v_0)\)</span>, is then equal to <span
class="math inline">\(\hat \beta_0 + \hat \beta_1 u_0 + \hat \beta_2 v_0
+ \hat \beta_3 u_0 v_0\)</span>.</p>
<p>This leads to a fit that is locally linear in <span
class="math inline">\(v\)</span> and globally linear in <span
class="math inline">\(u\)</span>, with different slopes in <span
class="math inline">\(u\)</span> conditional on different values of
<span class="math inline">\(v\)</span>.</p>
<p>To check your understanding: how would the fit change if you didn’t
include the <span class="math inline">\(u_iv_i\)</span> term?</p>
</div>
</div>
<div class="slide section level2">

<p>Locally quadratic fit in <span class="math inline">\(v\)</span> with
a globally quadratic fit in <span class="math inline">\(u\)</span>:</p>
<p>To find the value of the LOESS smoother at a point <span
class="math inline">\(x_0\)</span>, we find <span
class="math inline">\(\hat \beta_0, \ldots, \hat \beta_5\)</span> as
<span class="math display">\[
(\hat \beta_0, \ldots, \hat \beta_5) = \text{argmin}_{\beta_0, \ldots,
\beta_5}\sum_{i=1}^n w_i(x_0) (y_i - ( \beta_0 +  \beta_1 u_i +  \beta_2
v_i +  \beta_3 u_i v_i +  \beta_4 u_i^2 +  \beta_5 v_i^2))^2
\]</span> where the weights <span
class="math inline">\(w_i(x_0)\)</span> only take into account the <span
class="math inline">\(v\)</span> coordinates.</p>
<p>The fitted value of the LOESS smoother at <span
class="math inline">\(x_0\)</span>, <span class="math inline">\(\hat
g(x_0) = \hat g(u_0, v_0)\)</span>, is then equal to <span
class="math inline">\(\hat \beta_0 + \hat \beta_1 u_0 + \hat \beta_2 v_0
+ \hat \beta_3 u_0 v_0 + \hat \beta_4 u_i^2 + \hat \beta_5
v_i^2\)</span>.</p>
</div>
<div class="slide section level2">

<p>Locally quadratic fit in <span class="math inline">\(v\)</span> with
a globally linear fit in <span class="math inline">\(u\)</span>:</p>
<p>To find the value of the LOESS smoother at a point <span
class="math inline">\(x_0\)</span>, we find <span
class="math inline">\(\hat \beta_0, \ldots, \hat \beta_4\)</span> as
<span class="math display">\[
\hat \beta_0, \ldots, \hat \beta_4 = \text{argmin}_{\beta_0, \ldots,
\beta_4}\sum_{i=1}^n w_i(x_0) (y_i - ( \beta_0 +  \beta_1 u_i +  \beta_2
v_i +  \beta_3 u_i v_i +  \beta_4 v_i^2))^2
\]</span> where the weights <span
class="math inline">\(w_i(x_0)\)</span> only take into account the <span
class="math inline">\(v\)</span> coordinates.</p>
<p>The fitted value of the LOESS smoother at <span
class="math inline">\(x_0\)</span>, <span class="math inline">\(\hat
g(x_0) = \hat g(u_0, v_0)\)</span>, is then equal to <span
class="math inline">\(\hat \beta_0 + \hat \beta_1 u_0 + \hat \beta_2 v_0
+ \hat \beta_3 u_0 v_0+ \hat \beta_4 v_i^2\)</span>.</p>
</div>
<div id="loess-on-ethanol-data" class="slide section level2">
<h1>LOESS on ethanol data</h1>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;../../datasets/lattice.RData&quot;</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ethanol)</span></code></pre></div>
<pre><code>##     NOx  C     E
## 1 3.741 12 0.907
## 2 2.295 12 0.761
## 3 1.498 12 1.108
## 4 2.881 12 1.016
## 5 0.760 12 1.189
## 6 3.120  9 1.001</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>ethanol_lo <span class="ot">=</span> <span class="fu">loess</span>(NOx <span class="sc">~</span> C <span class="sc">*</span> E, <span class="at">data =</span> ethanol, <span class="at">span =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>, <span class="at">parametric =</span> <span class="st">&quot;C&quot;</span>, </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">drop.square =</span> <span class="st">&quot;C&quot;</span>, <span class="at">family =</span> <span class="st">&quot;symmetric&quot;</span>, <span class="at">degree =</span> <span class="dv">2</span>)</span></code></pre></div>
</div>
<div class="slide section level2">

<p>Arguments to the <code>loess</code> function:</p>
<ul>
<li>First argument is the formula: we want to model <code>NOx</code> as
a function of <code>C</code> and <code>E</code>, with an interaction
between the two variables.</li>
</ul>
<ul>
<li><code>data</code> gives tha data frame the variables come from.</li>
</ul>
<ul>
<li><code>span</code> gives the fraction of the observations that have
non-zero weight for each of the local regressions, the same as <span
class="math inline">\(\alpha\)</span> in the text.</li>
</ul>
<ul>
<li><code>degree</code> gives the degree of the local polynomial. If we
have variables <span class="math inline">\(u\)</span> and <span
class="math inline">\(v\)</span>, degree = <span
class="math inline">\(1\)</span> means the local regressions use <span
class="math inline">\(u\)</span> and <span
class="math inline">\(v\)</span> as predictors, and degree = <span
class="math inline">\(2\)</span> means the local regressions will use
<span class="math inline">\(u\)</span>, <span
class="math inline">\(v\)</span>, <span
class="math inline">\(uv\)</span>, <span
class="math inline">\(u^2\)</span>, and <span
class="math inline">\(v^2\)</span> as predictors.</li>
</ul>
<ul>
<li><code>family</code> is either symmetric or gaussian, gaussian means
the local regressions are fit by least squares, while symmetric means
they are fit with robust regression using Tukey’s biweight.</li>
</ul>
<ul>
<li><code>parametric</code>: The names of variables for which we want to
constrain the fit to be parametric. The parametric fit is achieved by
excluding these variables from the distance calculations when deciding
on observation weights in the local regressions.</li>
</ul>
<ul>
<li><code>drop.square</code>: By default, if degree = <span
class="math inline">\(2\)</span> and one of the variables is constrained
to be fit parametrically, the parametric fit will be of a degree <span
class="math inline">\(2\)</span> polynomial. <code>drop.square =
TRUE</code> changes this so that the parametric fit is linear instead of
quadratic.</li>
</ul>
</div>
<div class="slide section level2">

<p>What do the fitted values look like? First let’s make a coplot of the
fitted value given <code>E</code>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>prediction_grid <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="fu">expand.grid</span>(<span class="at">C =</span> <span class="fu">c</span>(<span class="fl">7.5</span>, <span class="dv">9</span>, <span class="dv">12</span>, <span class="dv">15</span>, <span class="dv">18</span>), <span class="at">E =</span> <span class="fu">seq</span>(<span class="fl">0.6</span>, <span class="fl">1.2</span>, <span class="at">length.out =</span> <span class="dv">11</span>)))</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>ethanol_preds <span class="ot">=</span> <span class="fu">augment</span>(ethanol_lo, <span class="at">newdata =</span> prediction_grid)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ethanol_preds) <span class="sc">+</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> C, <span class="at">y =</span> .fitted)) <span class="sc">+</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> E, <span class="at">ncol =</span> <span class="dv">11</span>)  <span class="sc">+</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust=</span><span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">12</span>, <span class="dv">16</span>)) <span class="sc">+</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="st">&quot;Fitted value of NOx&quot;</span>)</span></code></pre></div>
<p><img src="lecture-12-fig/unnamed-chunk-3-1.png" /></p>
<p>Note: The idea behind coplots of fitted values is the same as the
idea behind coplots of data. Still have:</p>
<ul>
<li>Response: This is now the fitted value instead of one of the
variables in the dataset.</li>
<li>Predictor: One of the original variables.</li>
<li>Given: One of the original variables.</li>
</ul>
<p>We still:</p>
<ul>
<li>Plot the response on the vertical axis, predictor on the horizontal
axis, and facet by given.</li>
</ul>
<p>Difference:</p>
<ul>
<li>Data don’t appear everywhere, but we can calculate fits for any
combination of response, predictor, and given variables.</li>
<li>Therefore, we don’t have to worry about creating intervals of the
given variable or anything like that. We can directly plot the fitted
values as a function of the predictor for any specified value of the
given variable.</li>
</ul>
</div>
<div class="slide section level2">

<p>Then a coplot of the fitted values given <code>C</code>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ethanol_preds) <span class="sc">+</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> E, <span class="at">y =</span> .fitted)) <span class="sc">+</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> C, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="st">&quot;Fitted value of NOx&quot;</span>)</span></code></pre></div>
<p><img src="lecture-12-fig/unnamed-chunk-4-1.png" /></p>
</div>
<div class="slide section level2">

<p>More useful without the faceting:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ethanol_preds) <span class="sc">+</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> E, <span class="at">y =</span> .fitted, <span class="at">color =</span> <span class="fu">factor</span>(C, <span class="at">levels =</span> <span class="fu">unique</span>(C), <span class="at">ordered =</span> <span class="cn">TRUE</span>))) <span class="sc">+</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">&quot;C&quot;</span>)) <span class="sc">+</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="st">&quot;Fitted value of NOx&quot;</span>)</span></code></pre></div>
<p><img src="lecture-12-fig/unnamed-chunk-5-1.png" /></p>
</div>
<div id="plotting-residuals" class="slide section level2">
<h1>Plotting residuals</h1>
<p>Remember <code>augment</code> from <code>broom</code>: if you just
ask it to augment the output from a linear model, it will give back a
data frame with the predictor variables used in the model along with
residuals and fitted values.</p>
<p>Here we’re looking for structure: systematic relationships between
the residuals and the preditor variables. If we see a relationship
between the predictors and the residuals, it indicates that the form of
the model doesn’t fit well and we need to use something more
flexible.</p>
<p>We first look at the residuals by <code>E</code> and
<code>C</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>ethanol_resid <span class="ot">=</span> <span class="fu">augment</span>(ethanol_lo)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ethanol_resid, <span class="fu">aes</span>(<span class="at">x =</span> E, <span class="at">y =</span> .resid)) <span class="sc">+</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">degree =</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="st">&quot;symmetric&quot;</span>)) <span class="sc">+</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="st">&quot;NOx Residual&quot;</span>)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula = &#39;y ~ x&#39;</code></pre>
<p><img src="lecture-12-fig/unnamed-chunk-6-1.png" /></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ethanol_resid, <span class="fu">aes</span>(<span class="at">x =</span> C, <span class="at">y =</span> .resid)) <span class="sc">+</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">degree =</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="st">&quot;symmetric&quot;</span>))  <span class="sc">+</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="st">&quot;NOx Residual&quot;</span>)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula = &#39;y ~ x&#39;</code></pre>
<p><img src="lecture-12-fig/unnamed-chunk-7-1.png" /></p>
</div>
<div class="slide section level2">

<p>Note: using the robust version of loess (<code>family =
"symmetric"</code>) helps a lot here. If we use the non-robust version,
the loess curve is pulled away from zero by the outliers.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>ethanol_resid <span class="ot">=</span> <span class="fu">augment</span>(ethanol_lo)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ethanol_resid, <span class="fu">aes</span>(<span class="at">x =</span> E, <span class="at">y =</span> .resid)) <span class="sc">+</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">degree =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="st">&quot;NOx Residual&quot;</span>)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula = &#39;y ~ x&#39;</code></pre>
<p><img src="lecture-12-fig/unnamed-chunk-8-1.png" /></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ethanol_resid, <span class="fu">aes</span>(<span class="at">x =</span> C, <span class="at">y =</span> .resid)) <span class="sc">+</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">degree =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="st">&quot;NOx Residual&quot;</span>)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula = &#39;y ~ x&#39;</code></pre>
<p><img src="lecture-12-fig/unnamed-chunk-9-1.png" /></p>
</div>
<div class="slide section level2">

<p>It’s also useful to look at coplots:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ethanol_resid, <span class="fu">aes</span>(<span class="at">x =</span> E, <span class="at">y =</span> .resid)) <span class="sc">+</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span> C) <span class="sc">+</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">degree =</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="st">&quot;symmetric&quot;</span>)) <span class="sc">+</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="st">&quot;NOx Residual&quot;</span>)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula = &#39;y ~ x&#39;</code></pre>
<p><img src="lecture-12-fig/unnamed-chunk-10-1.png" /></p>
<p>In all of the residual plots, we see outliers, but not any major
dependence of the residuals on the predictors.</p>
</div>
<div id="residuals-to-check-model-assumptions"
class="slide section level2">
<h1>Residuals to check model assumptions</h1>
<p>It’s also a good idea to check on homoscedasticity and normality of
the residuals.</p>
<p>To check for homoscedasticity, we plot the absolute value of the
residuals by the fitted value:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ethanol_resid, <span class="fu">aes</span>(<span class="at">x =</span> .fitted, <span class="at">y =</span> <span class="fu">abs</span>(.resid))) <span class="sc">+</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">degree =</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="st">&quot;symmetric&quot;</span>)) <span class="sc">+</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="st">&quot;Absolute value of NOx residual&quot;</span>) <span class="sc">+</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="st">&quot;NOx fitted value&quot;</span>)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula = &#39;y ~ x&#39;</code></pre>
<p><img src="lecture-12-fig/unnamed-chunk-11-1.png" /></p>
</div>
<div class="slide section level2">

<p>To check for normality, we make a QQ plot:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ethanol_resid) <span class="sc">+</span> <span class="fu">stat_qq</span>(<span class="fu">aes</span>(<span class="at">sample =</span> .resid))</span></code></pre></div>
<p><img src="lecture-12-fig/unnamed-chunk-12-1.png" /></p>
<p>We see that the residuals are quite heavy-tailed. This means:</p>
<ul>
<li>It’s good that we used a robust linear model.</li>
</ul>
<ul>
<li>We shouldn’t use normal-theory based confidence intervals or tests
for this data.</li>
</ul>
</div>
<div id="what-weve-learned" class="slide section level2">
<h1>What we’ve learned</h1>
<ul>
<li>NOx depends on equivalence ratio in a non-monotonic way.</li>
</ul>
<ul>
<li>Conditional on equivalence ratio, NOx depends on concentration in an
approximately linear way.</li>
</ul>
<ul>
<li>The interaction is important: there’s no real way to remove it from
the data.</li>
</ul>
<ul>
<li>The usual inference based on an assumption of normal errors is
inappropriate.</li>
</ul>
</div>
<div id="rubber-data" class="slide section level2">
<h1>Rubber data</h1>
<p>Reading: Cleveland pp. 180-187, 200-213</p>
<p>The data frame rubber in <code>lattice.RData</code> contains three
measurements on 30 specimens of tire rubber.</p>
<p>The variables are:</p>
<ul>
<li><code>hardness</code>: How much the rubber rebounds after being
indented.</li>
</ul>
<ul>
<li><code>tensile.strength</code>: The force per cross-sectional area
required to break the rubber (in kg/cm2).</li>
</ul>
<ul>
<li><code>abrasion.loss</code>: The amount of material lost to abrasion
when rubbing it per unit energy (in grams per hp-hour). This gives you
an idea how fast the tire will wear away when you drive. If we had to
choose a “response” variable, it would be this one.</li>
</ul>
</div>
<div id="pairs-plot-of-the-three-variables"
class="slide section level2">
<h1>Pairs plot of the three variables</h1>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GGally)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggpairs</span>(rubber[,<span class="fu">c</span>(<span class="st">&quot;hardness&quot;</span>, <span class="st">&quot;tensile.strength&quot;</span>, <span class="st">&quot;abrasion.loss&quot;</span>)])</span></code></pre></div>
<p><img src="lecture-12-fig/unnamed-chunk-13-1.png" /></p>
</div>
<div id="coplot-of-abrasion-loss-and-tensile-strength-given-hardness"
class="slide section level2">
<h1>Coplot of abrasion loss and tensile strength given hardness</h1>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>coplot_hardness <span class="ot">=</span> <span class="fu">make_coplot_df</span>(rubber, <span class="st">&quot;hardness&quot;</span>, <span class="at">number_bins =</span> <span class="dv">8</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(coplot_hardness, <span class="fu">aes</span>(<span class="at">x =</span> tensile.strength, <span class="at">y =</span> abrasion.loss)) <span class="sc">+</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> interval, <span class="at">ncol =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula = &#39;y ~ x&#39;</code></pre>
<p><img src="lecture-12-fig/unnamed-chunk-14-1.png" /></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(coplot_hardness, <span class="fu">aes</span>(<span class="at">x =</span> tensile.strength, <span class="at">y =</span> abrasion.loss)) <span class="sc">+</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> interval, <span class="at">ncol =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">degree =</span> <span class="dv">1</span>), <span class="at">se =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula = &#39;y ~ x&#39;</code></pre>
<p><img src="lecture-12-fig/unnamed-chunk-14-2.png" /></p>
<p>An easier way to make a coplot with ggplot is to use the
<code>cut_number</code> function:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rubber, <span class="fu">aes</span>(<span class="at">x =</span> tensile.strength, <span class="at">y =</span> abrasion.loss)) <span class="sc">+</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(. <span class="sc">~</span> <span class="fu">cut_number</span>(hardness, <span class="at">n =</span> <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">degree =</span> <span class="dv">1</span>, <span class="at">span =</span> .<span class="dv">9</span>), <span class="at">se =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula = &#39;y ~ x&#39;</code></pre>
<p><img src="lecture-12-fig/unnamed-chunk-15-1.png" /></p>
</div>
<div id="coplot-of-abrasion-loss-and-hardness-given-tensile-strength"
class="slide section level2">
<h1>Coplot of abrasion loss and hardness given tensile strength</h1>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>coplot_ts <span class="ot">=</span> <span class="fu">make_coplot_df</span>(rubber, <span class="st">&quot;tensile.strength&quot;</span>, <span class="at">number_bins =</span> <span class="dv">8</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(coplot_ts, <span class="fu">aes</span>(<span class="at">x =</span> hardness, <span class="at">y =</span> abrasion.loss)) <span class="sc">+</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> interval, <span class="at">ncol =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula = &#39;y ~ x&#39;</code></pre>
<p><img src="lecture-12-fig/unnamed-chunk-16-1.png" /></p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(coplot_ts, <span class="fu">aes</span>(<span class="at">x =</span> hardness, <span class="at">y =</span> abrasion.loss)) <span class="sc">+</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> interval, <span class="at">ncol =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">span =</span> .<span class="dv">5</span>, <span class="at">degree =</span> <span class="dv">1</span>), <span class="at">se =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula = &#39;y ~ x&#39;</code></pre>
<p><img src="lecture-12-fig/unnamed-chunk-17-1.png" /></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(coplot_ts, <span class="fu">aes</span>(<span class="at">x =</span> hardness, <span class="at">y =</span> abrasion.loss, <span class="at">color =</span> interval)) <span class="sc">+</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">span =</span> .<span class="dv">5</span>, <span class="at">degree =</span> <span class="dv">1</span>), <span class="at">se =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula = &#39;y ~ x&#39;</code></pre>
<p><img src="lecture-12-fig/unnamed-chunk-17-2.png" /></p>
</div>
<div id="exercises" class="slide section level2">
<h1>Exercises</h1>
<p>Try making the following additional plots:</p>
<ul>
<li>Make the same coplot as in the previous slide, but with a loess
smooth instead of a linear smooth. What do you think are good parameters
for the degree and span arguments?</li>
</ul>
<ul>
<li>It is sometimes easier to compare smoothers to each other if they
are on the same plot instead of faceted out. Using the same
<code>coplot_ts</code> data frame as on the previous slide, make a plot
with one smoother per <code>tensile.strength</code> interval, i.e., the
same smoothers as in the previous plot, but not faceted out. Let color
indicate which <code>tensile.strength</code> interval the smoother
corresponds to.</li>
</ul>
<p>Questions:</p>
<ul>
<li>What do these plots tell you about the interaction between
<code>tensile.strength</code> and <code>hardness</code>? Do you think
that we need to fit an interaction?</li>
</ul>
<ul>
<li>Based on the coplots given <code>hardness</code> and given
<code>tensile.strength</code>, do you think a linear fit is sufficient
for predicting <code>abrasion.loss</code>, or do we need to use a
non-linear function?</li>
</ul>
</div>
<div id="building-a-model" class="slide section level2">
<h1>Building a model</h1>
<p>Let’s start off building a model with no interaction but with a
non-linear function of <code>tensile.strength</code>.</p>
<p>To do this, we need to:</p>
<ul>
<li>Decide on a non-linear function to use.</li>
</ul>
<ul>
<li>Implement this function in R.</li>
</ul>
<ul>
<li>Apply the function to <code>tensile.strength</code>.</li>
</ul>
</div>
<div id="deciding-on-a-function" class="slide section level2">
<h1>Deciding on a function</h1>
<p>We want our non-linear function to be linear for values of
<code>tensile.strength</code> below 180, flat for values above 180, and
continuous. One such function is <span class="math display">\[
f(x) = \begin{cases}
x - 180 &amp; x \le 180\\
0 &amp; x &gt; 180
\end{cases}
\]</span></p>
</div>
<div id="writing-the-function-in-r" class="slide section level2">
<h1>Writing the function in R</h1>
<p>The way we would write this in R would be</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>tslow <span class="ot">=</span> <span class="cf">function</span>(x) {</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>((x <span class="sc">-</span> <span class="dv">180</span>) <span class="sc">*</span> (x <span class="sc">&lt;</span> <span class="dv">180</span>))</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="applying-the-function-to-tensile.strength"
class="slide section level2">
<h1>Applying the function to <code>tensile.strength</code></h1>
<p>And to create a variable corresponding to this transformation of
tensile strength, we could use</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>rubber <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">ts.low =</span> <span class="fu">tslow</span>(tensile.strength))</span></code></pre></div>
<p>However, we don’t need to do that because Cleveland has already done
it for us (the variable <code>ts.low</code> already exists in the data
set and is exactly this function of <code>tensile.strength</code>).</p>
</div>
<div id="fitting-and-visualizing-the-model"
class="slide section level2">
<h1>Fitting and visualizing the model</h1>
<p>To fit the model:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>rubber.rlm <span class="ot">=</span> <span class="fu">rlm</span>(abrasion.loss <span class="sc">~</span> hardness <span class="sc">+</span> ts.low, <span class="at">data =</span> rubber, </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">psi =</span> psi.bisquare)</span></code></pre></div>
</div>
<div class="slide section level2">

<p>To visualize the fitted model, we need to get fitted values from the
model on a grid of values of the two predictors.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>rubber.grid <span class="ot">=</span> <span class="fu">expand.grid</span>(<span class="at">hardness =</span> <span class="fu">c</span>(<span class="dv">54</span>, <span class="dv">64</span>, <span class="dv">74</span>, <span class="dv">84</span>),</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">tensile.strength =</span> <span class="fu">c</span>(<span class="dv">144</span>, <span class="dv">162</span>, <span class="dv">180</span>, <span class="dv">198</span>)) <span class="sc">%&gt;%</span> data.frame</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>rubber.grid <span class="ot">=</span> rubber.grid <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">ts.low =</span> <span class="fu">tslow</span>(tensile.strength))</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>rubber.predict <span class="ot">=</span> <span class="fu">augment</span>(rubber.rlm, <span class="at">newdata =</span> rubber.grid)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>rubber.predict</span></code></pre></div>
<pre><code>## # A tibble: 16 × 4
##    hardness tensile.strength ts.low .fitted
##       &lt;dbl&gt;            &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
##  1       54              144    -36   357. 
##  2       64              144    -36   289. 
##  3       74              144    -36   222. 
##  4       84              144    -36   154. 
##  5       54              162    -18   298. 
##  6       64              162    -18   230. 
##  7       74              162    -18   162. 
##  8       84              162    -18    94.8
##  9       54              180      0   238. 
## 10       64              180      0   171. 
## 11       74              180      0   103. 
## 12       84              180      0    35.3
## 13       54              198      0   238. 
## 14       64              198      0   171. 
## 15       74              198      0   103. 
## 16       84              198      0    35.3</code></pre>
</div>
<div class="slide section level2">

<p>Once we have the fitted values, we can make a coplot of the fitted
model. We’ll start with <code>hardness</code> as the given variable:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rubber.predict) <span class="sc">+</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> tensile.strength, <span class="at">y =</span> .fitted)) <span class="sc">+</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span> hardness) <span class="sc">+</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="st">&quot;Fitted abrasion loss&quot;</span>) <span class="sc">+</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust=</span><span class="dv">1</span>))</span></code></pre></div>
<p><img src="lecture-12-fig/unnamed-chunk-22-1.png" /></p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rubber.predict) <span class="sc">+</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> tensile.strength, <span class="at">y =</span> .fitted, <span class="at">color =</span> <span class="fu">factor</span>(hardness, <span class="at">ordered =</span> <span class="cn">TRUE</span>))) <span class="sc">+</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">&quot;Hardness&quot;</span>)) <span class="sc">+</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="st">&quot;Fitted abrasion loss&quot;</span>) <span class="sc">+</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust=</span><span class="dv">1</span>))</span></code></pre></div>
<p><img src="lecture-12-fig/unnamed-chunk-22-2.png" /></p>
<p>Note that the first plot is a coplot, the second doesn’t have a name
but reports the same information in a different way.</p>
</div>
<div class="slide section level2">

<p>Then a coplot with <code>tensile.strength</code> as the given
variable:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rubber.predict) <span class="sc">+</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> hardness, <span class="at">y =</span> .fitted)) <span class="sc">+</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span> tensile.strength) <span class="sc">+</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="st">&quot;Fitted abrasion loss&quot;</span>) <span class="sc">+</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust=</span><span class="dv">1</span>))</span></code></pre></div>
<p><img src="lecture-12-fig/unnamed-chunk-23-1.png" /></p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rubber.predict) <span class="sc">+</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> hardness, <span class="at">y =</span> .fitted, <span class="at">color =</span> <span class="fu">factor</span>(tensile.strength, <span class="at">ordered =</span> <span class="cn">TRUE</span>))) <span class="sc">+</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="st">&quot;Tensile strength&quot;</span>)) <span class="sc">+</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="st">&quot;Fitted abrasion loss&quot;</span>) <span class="sc">+</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust=</span><span class="dv">1</span>))</span></code></pre></div>
<p><img src="lecture-12-fig/unnamed-chunk-23-2.png" /></p>
</div>
<div id="residuals" class="slide section level2">
<h1>Residuals</h1>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>rubber.resid <span class="ot">=</span> <span class="fu">data.frame</span>(rubber, <span class="at">.resid =</span> <span class="fu">residuals</span>(rubber.rlm))</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rubber.resid, <span class="fu">aes</span>(<span class="at">x =</span> tensile.strength, <span class="at">y =</span> .resid)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="at">span =</span> <span class="dv">1</span>, <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">degree =</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="st">&quot;symmetric&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">0</span>, <span class="at">intercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="st">&quot;Abrasion loss residuals&quot;</span>)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula = &#39;y ~ x&#39;</code></pre>
<p><img src="lecture-12-fig/unnamed-chunk-24-1.png" /></p>
</div>
<div class="slide section level2">

<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rubber.resid, <span class="fu">aes</span>(<span class="at">x =</span> hardness, <span class="at">y =</span> .resid)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="at">span =</span> <span class="dv">1</span>, <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">degree =</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="st">&quot;symmetric&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">0</span>, <span class="at">intercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="st">&quot;Abrasion loss residuals&quot;</span>)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula = &#39;y ~ x&#39;</code></pre>
<p><img src="lecture-12-fig/unnamed-chunk-25-1.png" /></p>
</div>
<div id="coplots-of-the-residuals" class="slide section level2">
<h1>Coplots of the residuals</h1>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>resid_co_hardness <span class="ot">=</span> <span class="fu">make_coplot_df</span>(rubber.resid, <span class="at">faceting_variable =</span> <span class="st">&quot;hardness&quot;</span>, <span class="at">number_bins =</span> <span class="dv">4</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(resid_co_hardness, <span class="fu">aes</span>(<span class="at">x =</span> tensile.strength, <span class="at">y =</span> .resid)) <span class="sc">+</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span> interval) <span class="sc">+</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">degree =</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="st">&quot;symmetric&quot;</span>)) <span class="sc">+</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="st">&quot;Abrasion loss residuals&quot;</span>)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula = &#39;y ~ x&#39;</code></pre>
<p><img src="lecture-12-fig/unnamed-chunk-26-1.png" /></p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>resid_co_ts <span class="ot">=</span> <span class="fu">make_coplot_df</span>(rubber.resid, <span class="at">faceting_variable =</span> <span class="st">&quot;tensile.strength&quot;</span>, <span class="at">number_bins =</span> <span class="dv">4</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(resid_co_ts, <span class="fu">aes</span>(<span class="at">x =</span> hardness, <span class="at">y =</span> .resid)) <span class="sc">+</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span> interval) <span class="sc">+</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">degree =</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="st">&quot;symmetric&quot;</span>)) <span class="sc">+</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="st">&quot;Abrasion loss residuals&quot;</span>)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula = &#39;y ~ x&#39;</code></pre>
<p><img src="lecture-12-fig/unnamed-chunk-27-1.png" /></p>
</div>
<div id="second-round-model" class="slide section level2">
<h1>Second-round model</h1>
<p>From the residual plots, it looks like we might actually do better
fitting an interaction between <code>tensile.strength</code> and
hardness.</p>
<p>Exercises:</p>
<ul>
<li>Refit a linear model that predicts <code>abrasion.loss</code> using
an interaction between our non-linear transformation of
<code>tensile.strength</code> and <code>hardness</code> (i.e., change
<code>abrasion.loss ~ ts.low + hardness</code> to <code>abrasion.loss ~
ts.low * hardness</code>).</li>
</ul>
<ul>
<li>Plot the fitted values from the interaction model on the same grid
of predictor variables we used in the no-interaction model. How does the
form of the fits change when you add the interaction? Why is this?</li>
</ul>
<ul>
<li>Make residual plots and coplots for the interaction model in the
same way we did for the no-interaction model. Do you like this model
better?</li>
</ul>
</div>
<div id="final-plots" class="slide section level2">
<h1>Final plots</h1>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>coplot_hardness <span class="ot">=</span> coplot_hardness <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">interval_mean =</span> <span class="fu">get_interval_means</span>(interval))</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>rubber.grid.final <span class="ot">=</span> <span class="fu">expand.grid</span>(<span class="at">hardness =</span> <span class="fu">unique</span>(coplot_hardness<span class="sc">$</span>interval_mean),</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">tensile.strength =</span> <span class="fu">c</span>(<span class="dv">125</span>, <span class="dv">180</span>, <span class="dv">240</span>)) <span class="sc">%&gt;%</span> data.frame</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>rubber.grid.final <span class="ot">=</span> rubber.grid.final <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">ts.low =</span> <span class="fu">tslow</span>(tensile.strength))</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>rubber.predict.final <span class="ot">=</span> <span class="fu">augment</span>(rubber.rlm, <span class="at">newdata =</span> rubber.grid.final)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>rubber.predict.final <span class="ot">=</span> <span class="fu">merge</span>(rubber.predict.final,</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">unique</span>(coplot_hardness[,<span class="fu">c</span>(<span class="st">&quot;interval&quot;</span>, <span class="st">&quot;interval_mean&quot;</span>)]),</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>                             <span class="at">by.x =</span> <span class="st">&quot;hardness&quot;</span>, <span class="at">by.y =</span> <span class="st">&quot;interval_mean&quot;</span>)</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(coplot_hardness, <span class="fu">aes</span>(<span class="at">x =</span> tensile.strength, <span class="at">y =</span> abrasion.loss)) <span class="sc">+</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> tensile.strength, <span class="at">y =</span> .fitted), <span class="at">data =</span> rubber.predict.final) <span class="sc">+</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> interval, <span class="at">ncol =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="st">&quot;Abrasion loss&quot;</span>) <span class="sc">+</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="st">&quot;Tensile strength&quot;</span>)</span></code></pre></div>
<p><img src="lecture-12-fig/unnamed-chunk-28-1.png" /></p>
</div>
</body>
</html>
