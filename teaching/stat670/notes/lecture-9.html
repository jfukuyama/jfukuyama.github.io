<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Julia Fukuyama" />
  <title>Stat 470/670 Lecture 9: Smoothing bivariate data</title>
  <style type="text/css">
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" type="text/css" media="screen, projection, print"
    href="https://www.w3.org/Talks/Tools/Slidy2/styles/slidy.css" />
  <script
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js"
  type="text/javascript"></script>
  <script src="https://www.w3.org/Talks/Tools/Slidy2/scripts/slidy.js"
    charset="utf-8" type="text/javascript"></script>
</head>
<body>
<div class="slide titlepage">
  <h1 class="title">Stat 470/670 Lecture 9: Smoothing bivariate
data</h1>
  <p class="author">
Julia Fukuyama
  </p>
</div>
<div id="today" class="slide section level2">
<h1>Today</h1>
<ul class="incremental">
<li><p>Finish up LOESS</p></li>
<li><p>Introduce robust regression</p></li>
</ul>
</div>
<div id="loess" class="slide section level2">
<h1>LOESS</h1>
<p>LOESS, or local regression, builds on standard regression. The setup
is:</p>
<ul class="incremental">
<li><p>We have bivariate data, so pairs <span
class="math inline">\((y_i, x_i)\)</span>, <span class="math inline">\(i
= 1,\ldots, n\)</span>.</p></li>
<li><p>We want to estimate the mean <span class="math inline">\(E(Y \mid
X)\)</span>. We think this is a smooth function of <span
class="math inline">\(X\)</span>, but we don’t know what the form of
that function is.</p></li>
</ul>
<p>The idea is that since the mean function is smooth, it can be
approximated with a linear or low-order polynomial function in small
regions.</p>
</div>
<div id="loess-weights" class="slide section level2">
<h1>LOESS weights</h1>
<p>The way we transform this intuition into a concrete procedure is to
use weighted least squares.</p>
<p>LOESS has two parameters, <span class="math inline">\(\alpha\)</span>
(the span), and <span class="math inline">\(\lambda\)</span>, the degree
of the local polynomial.</p>
<p>To find the value of the LOESS smoother at a point <span
class="math inline">\(x_0\)</span>, we first define weights for all of
the samples: <span class="math display">\[
w_i(x_0) = T(\Delta_i(x_0) / \Delta_{(q)}(x_0))
\]</span> where <span class="math inline">\(\Delta_i(x_0) = |x_i -
x_0|\)</span>, <span class="math inline">\(\Delta_{(i)}(x_0)\)</span>
are the ordered values of <span
class="math inline">\(\Delta_{i}(x_0)\)</span>, and <span
class="math inline">\(q = \alpha n\)</span>, rounded to the nearest
integer.</p>
<p><span class="math inline">\(T\)</span> is the tricube weight function
(invented by Tukey!): <span class="math display">\[
T(u) = \begin{cases}
(1 - |u|^3)^3 &amp; |u| \le 1 \\
0 &amp; |u| &gt; 1
\end{cases}
\]</span></p>
</div>
<div class="slide section level2">

<p>Let’s see what this looks like. We’ll compute and plot weights, so
first we need to define the tricube function:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>tricube <span class="ot">&lt;-</span> <span class="cf">function</span>(u) {</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">abs</span>(u) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>((<span class="dv">1</span> <span class="sc">-</span> <span class="fu">abs</span>(u)<span class="sc">^</span><span class="dv">3</span>)<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Then we can define a function that computes the weights used by
LOESS:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param x0 The point</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param x A vector containing all of the weights</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param alpha The span argument in LOESS</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>loess_weights <span class="ot">&lt;-</span> <span class="cf">function</span>(x0, x, alpha) {</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="do">## x is a vector, x0 is a single number, so deltas</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="do">## is a vector the same length as x with elements |x_i - x0|</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    deltas <span class="ot">=</span> <span class="fu">abs</span>(x <span class="sc">-</span> x0)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="do">## this is a more parsimonious way of getting the</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="do">## delta_{(q)} value we defined on the previous slide</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    delta_q <span class="ot">=</span> <span class="fu">quantile</span>(deltas, <span class="at">probs =</span> alpha)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    weights <span class="ot">=</span> <span class="fu">sapply</span>(deltas <span class="sc">/</span> delta_q, tricube)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(weights)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div class="slide section level2">

<p>Let’s compute the weights on the economics data. We’ll first see what
it looks like for the default value of <span
class="math inline">\(\alpha\)</span>, <span
class="math inline">\(\alpha = .75\)</span>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code></pre></div>
<pre><code>## ── Attaching packages ──────────────────────────────────────── tidyverse 1.3.1 ──</code></pre>
<pre><code>## ✔ tibble  3.1.6     ✔ dplyr   1.0.7
## ✔ tidyr   1.1.4     ✔ stringr 1.4.0
## ✔ readr   2.1.1     ✔ forcats 0.5.1
## ✔ purrr   0.3.4</code></pre>
<pre><code>## ── Conflicts ─────────────────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span></code></pre></div>
<pre><code>## Error in library(viridis): there is no package called &#39;viridis&#39;</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>economics <span class="ot">=</span> <span class="fu">mutate</span>(economics, <span class="at">date_numeric =</span> <span class="fu">as.numeric</span>(date))</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(economics<span class="sc">$</span>date_numeric)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="do">## let&#39;s calculate the weights at date_numeric = 3446</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>weights <span class="ot">=</span> <span class="fu">loess_weights</span>(<span class="at">x0 =</span> <span class="dv">3446</span>, <span class="at">x =</span> economics<span class="sc">$</span>date_numeric, <span class="at">alpha =</span> .<span class="dv">75</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>economics<span class="sc">$</span>weights <span class="ot">=</span> weights</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(economics) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> weights))</span></code></pre></div>
<p><img src="lecture-9-fig/unnamed-chunk-3-1.png" /></p>
</div>
<div class="slide section level2">

<p>What if we decrease <span class="math inline">\(\alpha\)</span>?</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>weights <span class="ot">=</span> <span class="fu">loess_weights</span>(<span class="at">x0 =</span> <span class="dv">3446</span>, <span class="at">x =</span> economics<span class="sc">$</span>date_numeric, <span class="at">alpha =</span> .<span class="dv">1</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>economics<span class="sc">$</span>weights <span class="ot">=</span> weights</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(economics) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> weights))</span></code></pre></div>
<p><img src="lecture-9-fig/unnamed-chunk-4-1.png" /></p>
</div>
<div class="slide section level2">

<p>Notice that we have approximately <span class="math inline">\(\alpha
n\)</span> non-zero weights, and these are going to be the only points
that contribute to the LOESS fit.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(weights <span class="sc">!=</span> <span class="dv">0</span>)</span></code></pre></div>
<pre><code>## [1] 58</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="do">## weights was computed wih alpha = .1, so we have approximately n * .1 non-zero weights</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(weights) <span class="sc">*</span> .<span class="dv">1</span></span></code></pre></div>
<pre><code>## [1] 57.4</code></pre>
</div>
<div id="loess-fits" class="slide section level2">
<h1>LOESS fits</h1>
<p>These weights are then used in a local regression.</p>
<p>If <span class="math inline">\(\lambda = 1\)</span>, we find <span
class="math inline">\(\hat \beta_0\)</span>, <span
class="math inline">\(\hat \beta_1\)</span> to minimize the weighted
least squares criterion, <span class="math display">\[
\sum_{i=1}^n w_i (y_i - (\hat \beta_0 + \hat \beta_1 x_i))^2,
\]</span></p>
<p>and the fitted value for the LOESS smoother at <span
class="math inline">\(x_0\)</span> is <span class="math inline">\(\hat
\beta_0 + \hat \beta_1 x_0\)</span>.</p>
<div class="incremental">
<p>If <span class="math inline">\(\lambda = 2\)</span>, we use quadratic
regression, e.g. find <span class="math inline">\(\hat \beta_0\)</span>,
<span class="math inline">\(\hat \beta_1\)</span>, <span
class="math inline">\(\hat \beta_2\)</span> to minimize the weighted
least squares criterion, <span class="math display">\[
\sum_{i=1}^n w_i (y_i - (\hat \beta_0 + \hat \beta_1 x_i + \hat \beta_2
x_i^2))^2,
\]</span></p>
<p>and the fitted value for the LOESS smoother at <span
class="math inline">\(x_0\)</span> is <span class="math inline">\(\hat
\beta_0 + \hat \beta_1 x_0 + \hat \beta_2 x_0^2\)</span>.</p>
</div>
<div class="incremental">
<p>The analogous procedure works for any integer value of <span
class="math inline">\(\lambda\)</span>.</p>
</div>
</div>
<div class="slide section level2">

<p>Let’s use our weights function to do the LOESS fit manually. We’ll go
back to <span class="math inline">\(\alpha = .75\)</span></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>weights <span class="ot">=</span> <span class="fu">loess_weights</span>(<span class="at">x0 =</span> <span class="dv">3446</span>, <span class="at">x =</span> economics<span class="sc">$</span>date_numeric, <span class="at">alpha =</span> .<span class="dv">75</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>economics<span class="sc">$</span>weights <span class="ot">=</span> weights</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>econlm <span class="ot">=</span> <span class="fu">lm</span>(psavert <span class="sc">~</span> date_numeric,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> economics<span class="sc">$</span>weights, <span class="at">data =</span> economics)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="do">## normally we would use &#39;augment&#39; in &#39;broom&#39; to get the fitted values,</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="do">## but there&#39;s a bug there with zero weights</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>economics<span class="sc">$</span>loess.fits <span class="ot">=</span> econlm<span class="sc">$</span>fitted.values</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(economics) <span class="sc">+</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="do">## first we&#39;ll plot the raw data</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> psavert)) <span class="sc">+</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="do">## then we&#39;ll plot the local linear regression +</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> loess.fits, <span class="at">color =</span> weights),</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">2</span>, <span class="at">data =</span> <span class="fu">subset</span>(economics, weights <span class="sc">&gt;</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_viridis</span>()</span></code></pre></div>
<pre><code>## Error in scale_color_viridis(): could not find function &quot;scale_color_viridis&quot;</code></pre>
</div>
<div class="slide section level2">

<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>weights <span class="ot">=</span> <span class="fu">loess_weights</span>(<span class="at">x0 =</span> <span class="dv">3446</span>, <span class="at">x =</span> economics<span class="sc">$</span>date_numeric, <span class="at">alpha =</span> .<span class="dv">1</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>economics<span class="sc">$</span>weights <span class="ot">=</span> weights</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>econlm <span class="ot">=</span> <span class="fu">lm</span>(psavert <span class="sc">~</span> date_numeric <span class="sc">+</span> <span class="fu">I</span>(date_numeric<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> economics<span class="sc">$</span>weights, <span class="at">data =</span> economics)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="do">## normally we would use &#39;augment&#39; in &#39;broom&#39; to get the fitted values,</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="do">## but there&#39;s a bug there with zero weights</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>economics<span class="sc">$</span>loess.fits <span class="ot">=</span> econlm<span class="sc">$</span>fitted.values</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(economics) <span class="sc">+</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="do">## first we&#39;ll plot the raw data</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> psavert)) <span class="sc">+</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="do">## then we&#39;ll plot the local linear regression +</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> loess.fits, <span class="at">color =</span> weights),</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">2</span>, <span class="at">data =</span> <span class="fu">subset</span>(economics, weights <span class="sc">&gt;</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_viridis</span>()</span></code></pre></div>
<pre><code>## Error in scale_color_viridis(): could not find function &quot;scale_color_viridis&quot;</code></pre>
</div>
<div class="slide section level2">

<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>loess.smoother <span class="ot">=</span> <span class="fu">loess</span>(psavert <span class="sc">~</span> date_numeric, <span class="at">data =</span> economics)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>loess.rougher <span class="ot">=</span> <span class="fu">loess</span>(psavert <span class="sc">~</span> date_numeric, <span class="at">span =</span> .<span class="dv">1</span>, <span class="at">degree =</span> <span class="dv">2</span>, <span class="at">data =</span> economics)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(economics) <span class="sc">+</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> psavert)) <span class="sc">+</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> .fitted),</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> <span class="fu">augment</span>(loess.smoother, <span class="at">data =</span> economics), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> .fitted),</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> <span class="fu">augment</span>(loess.rougher, <span class="at">data =</span> economics), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">&quot;orange&quot;</span>)</span></code></pre></div>
<p><img src="lecture-9-fig/unnamed-chunk-8-1.png" /></p>
</div>
<div class="slide section level2">

<p>Note that we can also do this with <code>stat_smooth</code> in
ggplot:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(economics, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> psavert)) <span class="sc">+</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="at">span =</span> .<span class="dv">1</span>, <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">degree =</span> <span class="dv">2</span>), <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="at">span =</span> .<span class="dv">75</span>, <span class="at">method.args =</span> <span class="fu">list</span>(<span class="at">degree =</span> <span class="dv">2</span>), <span class="at">se =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula &#39;y ~ x&#39;
## `geom_smooth()` using formula &#39;y ~ x&#39;</code></pre>
<p><img src="lecture-9-fig/unnamed-chunk-9-1.png" /></p>
</div>
<div id="checking-loess-fits" class="slide section level2">
<h1>Checking LOESS fits</h1>
<p>As before, it’s useful to do residual plots to check LOESS fits. The
residual plots can tell us if we need to to allow for a more flexible
fit.</p>
<p>When we check the fit for the LOESS fit with <span
class="math inline">\(\alpha = .75\)</span>, we see that there is a lot
of structure in the residuals, suggesting a smaller value of <span
class="math inline">\(\alpha\)</span> is needed.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">augment</span>(loess.smoother, <span class="at">data =</span> economics)) <span class="sc">+</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> .resid))</span></code></pre></div>
<p><img src="lecture-9-fig/unnamed-chunk-10-1.png" /></p>
</div>
<div class="slide section level2">

<p>When we check the residuals for the model with <span
class="math inline">\(\alpha = .1\)</span>, there is less structure
(although some remains, and since this is time series data we really
should be using time series specific models).</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">augment</span>(loess.rougher, <span class="at">data =</span> economics)) <span class="sc">+</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> .resid))</span></code></pre></div>
<p><img src="lecture-9-fig/unnamed-chunk-11-1.png" /></p>
</div>
<div class="slide section level2">

<p>As a second example, let’s look at the LOESS fit and residuals on the
diamonds dataset.</p>
<p>First the fits:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>diamonds <span class="ot">=</span> <span class="fu">mutate</span>(diamonds, <span class="at">logprice =</span> <span class="fu">log10</span>(price))</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>loess.diamonds <span class="ot">=</span> <span class="fu">loess</span>(logprice <span class="sc">~</span> carat, <span class="at">subset =</span> clarity <span class="sc">==</span> <span class="st">&quot;VS1&quot;</span>, <span class="at">data =</span> diamonds)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">augment</span>(loess.diamonds)) <span class="sc">+</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> carat, <span class="at">y =</span> logprice), <span class="at">alpha =</span> .<span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> carat, <span class="at">y =</span> .fitted), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<p><img src="lecture-9-fig/unnamed-chunk-12-1.png" /></p>
</div>
<div class="slide section level2">

<p>Then the residuals:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">augment</span>(loess.diamonds)) <span class="sc">+</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> carat, <span class="at">y =</span> logprice <span class="sc">-</span> .fitted), <span class="at">alpha =</span> .<span class="dv">1</span>)</span></code></pre></div>
<p><img src="lecture-9-fig/unnamed-chunk-13-1.png" /></p>
<p>The fact that the residuals still show structure suggests that we
should decrease the span.</p>
</div>
<div class="slide section level2">

<p>We can try decreasing the span even more, but the fit still isn’t
flexible enough and some structure in the residuals remains:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>loess.diamonds.rougher <span class="ot">=</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">loess</span>(logprice <span class="sc">~</span> carat, <span class="at">subset =</span> clarity <span class="sc">==</span> <span class="st">&quot;VS1&quot;</span>,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> diamonds, <span class="at">span =</span> .<span class="dv">2</span>, <span class="at">degree =</span> <span class="dv">2</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">augment</span>(loess.diamonds.rougher)) <span class="sc">+</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> carat, <span class="at">y =</span> logprice), <span class="at">alpha =</span> .<span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> carat, <span class="at">y =</span> .fitted), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<p><img src="lecture-9-fig/unnamed-chunk-14-1.png" /></p>
</div>
<div class="slide section level2">

<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">augment</span>(loess.diamonds.rougher)) <span class="sc">+</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> carat, <span class="at">y =</span> logprice <span class="sc">-</span> .fitted), <span class="at">alpha =</span> .<span class="dv">1</span>)</span></code></pre></div>
<p><img src="lecture-9-fig/unnamed-chunk-15-1.png" /></p>
</div>
<div id="summing-up" class="slide section level2">
<h1>Summing up</h1>
<p>Once we understand that LOESS is a weighted regression, we have some
guidance about how to choose the parameters.</p>
<ul class="incremental">
<li><p><span class="math inline">\(\alpha\)</span> and <span
class="math inline">\(\lambda\)</span> (span and degree) should be
chosen so that the local regressions fit the data well.</p></li>
<li><p>Very wiggly functions will require larger <span
class="math inline">\(\lambda\)</span> and smaller <span
class="math inline">\(\alpha\)</span>.</p></li>
<li><p>With smooth functions we can use smaller <span
class="math inline">\(\lambda\)</span> and larger <span
class="math inline">\(\alpha\)</span>.</p></li>
</ul>
<div class="incremental">
<p>When will LOESS be helpful?</p>
<ul class="incremental">
<li><p>We expect the mean function, <span class="math inline">\(E(Y \mid
X)\)</span>, to be smooth.</p></li>
<li><p>When we don’t have that many data points, LOESS can help
visualize the mean function. However, this requires you to believe in
your smoother, and you might be skeptical.</p></li>
<li><p>When we have so many data points that it’s hard to see the mean
(diamonds dataset)</p></li>
<li><p>With an intermediate number of data points (like in the economics
dataset) we do the smoothing by eye automatically and it doesn’t seem as
helpful, but it can still help if you have many sets of points that you
want to compare.</p></li>
</ul>
</div>
</div>
<div id="robust-regression" class="slide section level2">
<h1>Robust regression</h1>
<p>The data set <code>dating</code> (in <code>lattice.RData</code>)
contains paired observations giving the estimated ages of 19 coral
samples in thousands of years using both carbon dating (the traditional
method) and thorium dating (a modern and purportedly more accurate
method.) What’s the difference between these two methods?</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;../../datasets/lattice.RData&quot;</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dating, <span class="fu">aes</span>(<span class="at">x =</span> carbon, <span class="at">y =</span> thorium <span class="sc">-</span> carbon)) <span class="sc">+</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>()</span></code></pre></div>
<p><img src="lecture-9-fig/unnamed-chunk-16-1.png" /></p>
<p>We notice a couple of things: thorium dating is always greater than
carbon dating, and the increase gets bigger for larger values of
carbon.</p>
<p>We could try to describe this relation with a linear fit.</p>
</div>
<div class="slide section level2">

<p>Let’s fit the model and plot the fitted values and the residuals:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>dating <span class="ot">=</span> <span class="fu">mutate</span>(dating, <span class="at">diff =</span> thorium <span class="sc">-</span> carbon)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>dating.lm <span class="ot">=</span> <span class="fu">lm</span>(diff <span class="sc">~</span> carbon, <span class="at">data =</span> dating)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">augment</span>(dating.lm)) <span class="sc">+</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> carbon, <span class="at">y =</span> diff)) <span class="sc">+</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> carbon, <span class="at">y =</span> .fitted))</span></code></pre></div>
<p><img src="lecture-9-fig/unnamed-chunk-17-1.png" /></p>
<div class="incremental">
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">augment</span>(dating.lm, <span class="at">data =</span> dating)) <span class="sc">+</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> carbon, <span class="at">y =</span> diff <span class="sc">-</span> .fitted)) <span class="sc">+</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;residuals&quot;</span>)</span></code></pre></div>
<p><img src="lecture-9-fig/unnamed-chunk-18-1.png" /></p>
</div>
</div>
<div class="slide section level2">

<p>The problem is that the couple of outliers with high
<code>carbon</code> values are dragging the line down.</p>
<p>It seems that there is a linear relationship in most of the data,
with a couple of outliers that need to be explained separately.</p>
<p>We could solve this problem by excluding the outliers and fitting a
linear model to the remainder, but there is another solution in robust
regression.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span></code></pre></div>
<pre><code>## 
## Attaching package: &#39;MASS&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:dplyr&#39;:
## 
##     select</code></pre>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>dating.rlm.huber <span class="ot">=</span> <span class="fu">rlm</span>(diff <span class="sc">~</span> carbon, <span class="at">data =</span> dating, <span class="at">psi =</span> psi.huber, <span class="at">maxit =</span> <span class="dv">100</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>dating.rlm.bisquare <span class="ot">=</span> <span class="fu">rlm</span>(diff <span class="sc">~</span> carbon, <span class="at">data =</span> dating, <span class="at">psi =</span> psi.bisquare)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dating) <span class="sc">+</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="do">## raw data</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> carbon, <span class="at">y =</span> diff)) <span class="sc">+</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="do">## rlm bisquare fit</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> carbon, <span class="at">y =</span> dating.rlm.bisquare<span class="sc">$</span>fitted.values), <span class="at">color =</span> <span class="st">&#39;red&#39;</span>) <span class="sc">+</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="do">## rlm huber fit</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> carbon, <span class="at">y =</span> .fitted), <span class="at">color =</span> <span class="st">&#39;orange&#39;</span>, <span class="at">data =</span> <span class="fu">augment</span>(dating.rlm.huber)) <span class="sc">+</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    <span class="do">## lm fit</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> carbon, <span class="at">y =</span> .fitted), <span class="at">data =</span> <span class="fu">augment</span>(dating.lm), <span class="at">color =</span> <span class="st">&#39;blue&#39;</span>)</span></code></pre></div>
<p><img src="lecture-9-fig/unnamed-chunk-19-1.png" /></p>
</div>
<div class="slide section level2">

<p>A residual plot shows us that the bisquare robust fit does a really
good job at explaining most of the data and almost completely ignores
the couple of points with high values of <code>carbon</code>.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dating) <span class="sc">+</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> carbon, <span class="at">y =</span> dating.rlm.bisquare<span class="sc">$</span>resid)) <span class="sc">+</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;residuals from bisquare fit&quot;</span>)</span></code></pre></div>
<p><img src="lecture-9-fig/unnamed-chunk-20-1.png" /></p>
</div>
<div id="next-time" class="slide section level2">
<h1>Next time</h1>
<ul class="incremental">
<li><p>How robust fits work</p></li>
<li><p>Comparing bivariate data</p></li>
</ul>
</div>
</body>
</html>
