<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title>Stat 610 Lecture 7: Split/apply/combine</title>
  <style type="text/css">
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" type="text/css" media="screen, projection, print"
    href="https://www.w3.org/Talks/Tools/Slidy2/styles/slidy.css" />
  <script src="https://www.w3.org/Talks/Tools/Slidy2/scripts/slidy.js"
    charset="utf-8" type="text/javascript"></script>
</head>
<body>
<div class="slide titlepage">
  <h1 class="title">Stat 610 Lecture 7: Split/apply/combine</h1>
</div>
<div id="avoiding-iteration-splitapplycombine"
class="slide section level2">
<h1>Avoiding iteration, split/apply/combine</h1>
<p>Reading: R Cookbook, Chapter 6</p>
<p>Agenda for today:</p>
<ul class="incremental">
<li><p>Avoiding iteration in base R</p></li>
<li><p>Split/apply/combine</p></li>
</ul>
</div>
<div id="avoiding-iteration" class="slide section level2">
<h1>Avoiding iteration</h1>
<p>We’ve already seen a lot of examples of functions in R that are
written so as to avoid iteration.</p>
<p>Built-in functions for making sequences or repeating elements, for
example, we can say:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">11</span>, <span class="at">by =</span> <span class="dv">2</span>)</span></code></pre></div>
<p>instead of</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="dv">6</span>)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x)) {</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>    x[i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> (i <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div class="slide section level2">

<p>Most of the built-in functions are vectorized, so we can use</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>log_x <span class="ot">&lt;-</span> <span class="fu">log</span>(x)</span></code></pre></div>
<p>instead of</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>log_x <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(x))</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x)) {</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    log_x[i] <span class="ot">&lt;-</span> <span class="fu">log</span>(x[i])</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div class="slide section level2">

<p>Plus a whole bunch we haven’t seen yet, like <code>rowSums</code>,
<code>colMeans</code>, <code>sweep</code>, <code>scale</code></p>
<p>However, not everything is vectorized, and you will often want to go
beyond the built-in functions, and for that you use the
<code>*apply</code> family of functions.</p>
</div>
<div id="applying-to-one-dimensional-structures"
class="slide section level2">
<h1>Applying to one-dimensional structures</h1>
<p><code>lapply</code>, and <code>sapply</code> will apply a function to
a one-dimensional structure.</p>
<p>The difference between them is how the output is formatted.</p>
<p>They have the same syntax: <code>lapply(X = x, FUN = fun, ...)</code>
and <code>sapply(X = x, FUN = fun, ...)</code></p>
<ul class="incremental">
<li><p><code>x</code> is a vector or list that the function should be
applied to</p></li>
<li><p><code>fun</code> is the function that should be applied to each
element of the vector or the list</p></li>
<li><p>You can specify other arguments in the <code>...</code> portion.
<code>fun</code> will be called with first argument equal to each
element of <code>x</code>, and subsequent arguments anything you specify
in the <code>...</code> portion.</p></li>
</ul>
<div class="incremental">
<p>Return values:</p>
<ul class="incremental">
<li><p><code>lapply</code> returns a list with length equal to the
length of <code>x</code> containing the result of the function
evaluation on the corresponding element of <code>x</code>.</p></li>
<li><p><code>sapply</code> tries to simplify the output to a vector or
matrix. If each element of the output is of length 1 it returns a
vector. If each element has the same length of two or more, it returns a
matrix. Otherwise it returns a list like <code>lapply</code>.</p></li>
</ul>
</div>
</div>
<div class="slide section level2">

<p>Example of <code>lapply</code></p>
<div class="incremental">
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>data_dir <span class="ot">&lt;-</span> <span class="st">&quot;~/GitHub/stat-comp-fall-22/lectures/lecture07/bglobin_annotations&quot;</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>file_names <span class="ot">&lt;-</span> <span class="fu">list.files</span>(data_dir, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>annotations <span class="ot">&lt;-</span> <span class="fu">lapply</span>(file_names, read.csv)</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>annotations <span class="ot">&lt;-</span> <span class="fu">lapply</span>(file_names, read.csv, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="fu">lapply</span>(annotations[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>], summary)</span></code></pre></div>
<pre><code>## [[1]]
##   unique_ids           v_gene             d_gene             j_gene         
##  Length:136         Length:136         Length:136         Length:136        
##  Class :character   Class :character   Class :character   Class :character  
##  Mode  :character   Mode  :character   Mode  :character   Mode  :character  
##                                                                             
##                                                                             
##                                                                             
##   cdr3_length    mut_freqs         n_mutations       input_seqs       
##  Min.   :366   Min.   :0.000000   Min.   :  0.000   Length:136        
##  1st Qu.:367   1st Qu.:0.004951   1st Qu.:  2.000   Class :character  
##  Median :367   Median :0.009901   Median :  4.000   Mode  :character  
##  Mean   :367   Mean   :0.021003   Mean   :  8.485                     
##  3rd Qu.:367   3rd Qu.:0.022277   3rd Qu.:  9.000                     
##  Max.   :367   Max.   :0.544554   Max.   :220.000                     
##  indel_reversed_seqs  naive_seq           indelfos         duplicates    
##  Length:136          Length:136         Length:136         Mode:logical  
##  Class :character    Class :character   Class :character   NA&#39;s:136      
##  Mode  :character    Mode  :character   Mode  :character                 
##                                                                          
##                                                                          
##                                                                          
##  v_per_gene_support d_per_gene_support j_per_gene_support    v_3p_del      
##  Mode:logical       Mode:logical       Mode:logical       Min.   :0.00000  
##  NA&#39;s:136           NA&#39;s:136           NA&#39;s:136           1st Qu.:0.00000  
##                                                           Median :0.00000  
##                                                           Mean   :0.08824  
##                                                           3rd Qu.:0.00000  
##                                                           Max.   :9.00000  
##     d_5p_del    d_3p_del    j_5p_del    v_5p_del    j_3p_del vd_insertion      
##  Min.   :0   Min.   :0   Min.   :0   Min.   :0   Min.   :0   Length:136        
##  1st Qu.:0   1st Qu.:0   1st Qu.:0   1st Qu.:0   1st Qu.:0   Class :character  
##  Median :0   Median :0   Median :0   Median :0   Median :0   Mode  :character  
##  Mean   :0   Mean   :0   Mean   :0   Mean   :0   Mean   :0                     
##  3rd Qu.:0   3rd Qu.:0   3rd Qu.:0   3rd Qu.:0   3rd Qu.:0                     
##  Max.   :0   Max.   :0   Max.   :0   Max.   :0   Max.   :0                     
##  dj_insertion   fv_insertion   jf_insertion   mutated_invariants
##  Mode:logical   Mode:logical   Mode:logical   Length:136        
##  NA&#39;s:136       NA&#39;s:136       NA&#39;s:136       Class :character  
##                                               Mode  :character  
##                                                                 
##                                                                 
##                                                                 
##   in_frames            stops               k_v                k_d           
##  Length:136         Length:136         Length:136         Length:136        
##  Class :character   Class :character   Class :character   Class :character  
##  Mode  :character   Mode  :character   Mode  :character   Mode  :character  
##                                                                             
##                                                                             
##                                                                             
##  padlefts       padrights      all_matches         mut_freqs.1      
##  Mode:logical   Mode:logical   Length:136         Min.   :0.000000  
##  NA&#39;s:136       NA&#39;s:136       Class :character   1st Qu.:0.004951  
##                                Mode  :character   Median :0.009901  
##                                                   Mean   :0.021003  
##                                                   3rd Qu.:0.022277  
##                                                   Max.   :0.544554  
## 
## [[2]]
##   unique_ids           v_gene             d_gene             j_gene         
##  Length:214         Length:214         Length:214         Length:214        
##  Class :character   Class :character   Class :character   Class :character  
##  Mode  :character   Mode  :character   Mode  :character   Mode  :character  
##                                                                             
##                                                                             
##                                                                             
##   cdr3_length    mut_freqs         n_mutations       input_seqs       
##  Min.   :365   Min.   :0.000000   Min.   :  0.000   Length:214        
##  1st Qu.:367   1st Qu.:0.002475   1st Qu.:  1.000   Class :character  
##  Median :367   Median :0.002475   Median :  1.000   Mode  :character  
##  Mean   :367   Mean   :0.009892   Mean   :  3.995                     
##  3rd Qu.:367   3rd Qu.:0.004951   3rd Qu.:  2.000                     
##  Max.   :368   Max.   :0.559406   Max.   :226.000                     
##  indel_reversed_seqs  naive_seq           indelfos         duplicates    
##  Length:214          Length:214         Length:214         Mode:logical  
##  Class :character    Class :character   Class :character   NA&#39;s:214      
##  Mode  :character    Mode  :character   Mode  :character                 
##                                                                          
##                                                                          
##                                                                          
##  v_per_gene_support d_per_gene_support j_per_gene_support    v_3p_del     
##  Mode:logical       Mode:logical       Mode:logical       Min.   :0.0000  
##  NA&#39;s:214           NA&#39;s:214           NA&#39;s:214           1st Qu.:0.0000  
##                                                           Median :0.0000  
##                                                           Mean   :0.1776  
##                                                           3rd Qu.:0.0000  
##                                                           Max.   :9.0000  
##     d_5p_del    d_3p_del    j_5p_del    v_5p_del    j_3p_del vd_insertion      
##  Min.   :0   Min.   :0   Min.   :0   Min.   :0   Min.   :0   Length:214        
##  1st Qu.:0   1st Qu.:0   1st Qu.:0   1st Qu.:0   1st Qu.:0   Class :character  
##  Median :0   Median :0   Median :0   Median :0   Median :0   Mode  :character  
##  Mean   :0   Mean   :0   Mean   :0   Mean   :0   Mean   :0                     
##  3rd Qu.:0   3rd Qu.:0   3rd Qu.:0   3rd Qu.:0   3rd Qu.:0                     
##  Max.   :0   Max.   :0   Max.   :0   Max.   :0   Max.   :0                     
##  dj_insertion   fv_insertion   jf_insertion   mutated_invariants
##  Mode:logical   Mode:logical   Mode:logical   Length:214        
##  NA&#39;s:214       NA&#39;s:214       NA&#39;s:214       Class :character  
##                                               Mode  :character  
##                                                                 
##                                                                 
##                                                                 
##   in_frames            stops               k_v                k_d           
##  Length:214         Length:214         Length:214         Length:214        
##  Class :character   Class :character   Class :character   Class :character  
##  Mode  :character   Mode  :character   Mode  :character   Mode  :character  
##                                                                             
##                                                                             
##                                                                             
##  padlefts       padrights      all_matches         mut_freqs.1      
##  Mode:logical   Mode:logical   Length:214         Min.   :0.000000  
##  NA&#39;s:214       NA&#39;s:214       Class :character   1st Qu.:0.002475  
##                                Mode  :character   Median :0.002475  
##                                                   Mean   :0.009892  
##                                                   3rd Qu.:0.004951  
##                                                   Max.   :0.559406  
## 
## [[3]]
##   unique_ids           v_gene             d_gene             j_gene         
##  Length:201         Length:201         Length:201         Length:201        
##  Class :character   Class :character   Class :character   Class :character  
##  Mode  :character   Mode  :character   Mode  :character   Mode  :character  
##                                                                             
##                                                                             
##                                                                             
##   cdr3_length      mut_freqs         n_mutations      input_seqs       
##  Min.   :294.0   Min.   :0.000000   Min.   : 0.000   Length:201        
##  1st Qu.:367.0   1st Qu.:0.002475   1st Qu.: 1.000   Class :character  
##  Median :367.0   Median :0.002475   Median : 1.000   Mode  :character  
##  Mean   :366.6   Mean   :0.005742   Mean   : 2.299                     
##  3rd Qu.:367.0   3rd Qu.:0.004950   3rd Qu.: 2.000                     
##  Max.   :368.0   Max.   :0.057402   Max.   :20.000                     
##  indel_reversed_seqs  naive_seq           indelfos         duplicates    
##  Length:201          Length:201         Length:201         Mode:logical  
##  Class :character    Class :character   Class :character   NA&#39;s:201      
##  Mode  :character    Mode  :character   Mode  :character                 
##                                                                          
##                                                                          
##                                                                          
##  v_per_gene_support d_per_gene_support j_per_gene_support    v_3p_del      
##  Mode:logical       Mode:logical       Mode:logical       Min.   : 0.0000  
##  NA&#39;s:201           NA&#39;s:201           NA&#39;s:201           1st Qu.: 0.0000  
##                                                           Median : 0.0000  
##                                                           Mean   : 0.5373  
##                                                           3rd Qu.: 0.0000  
##                                                           Max.   :74.0000  
##     d_5p_del    d_3p_del    j_5p_del    v_5p_del    j_3p_del vd_insertion      
##  Min.   :0   Min.   :0   Min.   :0   Min.   :0   Min.   :0   Length:201        
##  1st Qu.:0   1st Qu.:0   1st Qu.:0   1st Qu.:0   1st Qu.:0   Class :character  
##  Median :0   Median :0   Median :0   Median :0   Median :0   Mode  :character  
##  Mean   :0   Mean   :0   Mean   :0   Mean   :0   Mean   :0                     
##  3rd Qu.:0   3rd Qu.:0   3rd Qu.:0   3rd Qu.:0   3rd Qu.:0                     
##  Max.   :0   Max.   :0   Max.   :0   Max.   :0   Max.   :0                     
##  dj_insertion   fv_insertion   jf_insertion   mutated_invariants
##  Mode:logical   Mode:logical   Mode:logical   Length:201        
##  NA&#39;s:201       NA&#39;s:201       NA&#39;s:201       Class :character  
##                                               Mode  :character  
##                                                                 
##                                                                 
##                                                                 
##   in_frames            stops               k_v                k_d           
##  Length:201         Length:201         Length:201         Length:201        
##  Class :character   Class :character   Class :character   Class :character  
##  Mode  :character   Mode  :character   Mode  :character   Mode  :character  
##                                                                             
##                                                                             
##                                                                             
##  padlefts       padrights      all_matches         mut_freqs.1      
##  Mode:logical   Mode:logical   Length:201         Min.   :0.000000  
##  NA&#39;s:201       NA&#39;s:201       Class :character   1st Qu.:0.002475  
##                                Mode  :character   Median :0.002475  
##                                                   Mean   :0.005742  
##                                                   3rd Qu.:0.004950  
##                                                   Max.   :0.057402</code></pre>
<p>We need to do this because <code>read.csv</code> doesn’t vectorize.
Check what happens if you do <code>read_file(file_names)</code> (you’ll
have to change <code>data_dir</code> to wherever you saved the data
to).</p>
</div>
</div>
<div class="slide section level2">

<div class="incremental">
<p>Example of <code>sapply</code></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">sapply</span>(annotations, nrow)</span></code></pre></div>
<pre><code>##  [1] 136 214 201 186 231 112  86 123  52 132</code></pre>
</div>
</div>
<div id="applying-to-two-dimensional-structures"
class="slide section level2">
<h1>Applying to two-dimensional structures</h1>
<p>Syntax: <code>apply(X = mat, MARGIN = dim, FUN = fun, ...)</code></p>
<ul class="incremental">
<li><p><code>mat</code>: The matrix or data frame you want to apply the
function to.</p></li>
<li><p><code>dim</code>: Either 1 or 2: 1 means apply the function to
each row in <code>mat</code>, 2 means apply the function to each column
in <code>mat</code>. (1 and 2 are related to the way the dimensions are
laid out: the first dimension in the matrix is the number of rows, the
second is the number of columns.)</p></li>
<li><p><code>fun</code>: The function you want to apply to each row or
to each column. It should take a vector as its first argument.</p></li>
<li><p><code>...</code>: Extra arguments to be passed to
<code>fun</code>.</p></li>
</ul>
<p>As with <code>lapply</code> and <code>sapply</code>, <code>fun</code>
will be called with each row or each column of <code>mat</code> as its
first argument, along with any extra arguments specified after the
function.</p>
</div>
<div class="slide section level2">

<p>Some simple examples:</p>
<div class="incremental">
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">sample</span>(<span class="sc">-</span><span class="dv">5</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">size =</span> <span class="dv">20</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>), <span class="at">nrow =</span> <span class="dv">4</span>, <span class="at">ncol =</span> <span class="dv">5</span>)</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>X</span></code></pre></div>
<pre><code>##      [,1] [,2] [,3] [,4] [,5]
## [1,]    3   -4    5   -1    1
## [2,]   -2    1   -3    4    3
## [3,]    1    5   -5    0   -1
## [4,]   -5   -4   -1    4   -1</code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="fu">apply</span>(X, <span class="dv">2</span>, min)</span></code></pre></div>
<pre><code>## [1] -5 -4 -5 -1 -1</code></pre>
</div>
</div>
<div class="slide section level2">

<div class="incremental">
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>log_X <span class="ot">&lt;-</span> <span class="fu">log</span>(X)</span></code></pre></div>
<pre><code>## Warning in log(X): NaNs produced</code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>log_X</span></code></pre></div>
<pre><code>##          [,1]     [,2]     [,3]     [,4]     [,5]
## [1,] 1.098612      NaN 1.609438      NaN 0.000000
## [2,]      NaN 0.000000      NaN 1.386294 1.098612
## [3,] 0.000000 1.609438      NaN     -Inf      NaN
## [4,]      NaN      NaN      NaN 1.386294      NaN</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="fu">apply</span>(log_X, <span class="dv">1</span>, min, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>## [1] 0.000000 0.000000     -Inf 1.386294</code></pre>
</div>
</div>
<div class="slide section level2">

<p>Be careful when using apply on rows of a data frame: apply assumes
the argument you pass to the function is a vector, and will coerce the
rows of the data frame to vectors to make it so.</p>
<div class="incremental">
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>steak_combinations <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>    <span class="at">temp =</span> <span class="fu">c</span>(<span class="dv">90</span>, <span class="dv">120</span>, <span class="dv">135</span>, <span class="dv">105</span>),</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>    <span class="at">type =</span> <span class="fu">c</span>(<span class="st">&quot;rare&quot;</span>, <span class="st">&quot;med_rare&quot;</span>, <span class="st">&quot;med_rare&quot;</span>, <span class="st">&quot;rare&quot;</span>))</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>steak_admonishments_for_apply <span class="ot">&lt;-</span> <span class="cf">function</span>(temp_and_type) {</span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>    temp <span class="ot">&lt;-</span> temp_and_type[<span class="dv">1</span>]</span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>    steak_type <span class="ot">&lt;-</span> temp_and_type[<span class="dv">2</span>]</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>    <span class="cf">if</span>(steak_type <span class="sc">==</span> <span class="st">&quot;rare&quot;</span> <span class="sc">&amp;&amp;</span> temp <span class="sc">&gt;</span> <span class="dv">115</span>) {</span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>        admonishment <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;Your steak is overcooked by %f degrees!&quot;</span>, temp <span class="sc">-</span> <span class="dv">115</span>)</span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a>        <span class="fu">return</span>(admonhishment)</span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span>(steak_type <span class="sc">==</span> <span class="st">&quot;med_rare&quot;</span> <span class="sc">&amp;&amp;</span> temp <span class="sc">&gt;</span> <span class="dv">125</span>) {</span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a>        admonishment <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;Your steak is overcooked by %f degrees!&quot;</span>, temp <span class="sc">-</span> <span class="dv">125</span>)</span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a>        <span class="fu">return</span>(admonishment)</span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a>    }</span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a>    <span class="st">&quot;Your steak is not overcooked yet&quot;</span></span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a>}</span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a><span class="fu">apply</span>(steak_combinations, <span class="dv">1</span>, steak_admonishments_for_apply)</span></code></pre></div>
<pre><code>## Error in temp - 125: non-numeric argument to binary operator</code></pre>
</div>
</div>
<div class="slide section level2">

<p>This version doesn’t work properly but also doesn’t throw an
error.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>steak_combinations <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>    <span class="at">temp =</span> <span class="fu">c</span>(<span class="dv">90</span>, <span class="dv">99</span>),</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>    <span class="at">type =</span> <span class="fu">c</span>(<span class="st">&quot;rare&quot;</span>, <span class="st">&quot;med_rare&quot;</span>))</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a>steak_directions_for_apply <span class="ot">&lt;-</span> <span class="cf">function</span>(temp_and_type) {</span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a>    temp <span class="ot">&lt;-</span> temp_and_type[<span class="dv">1</span>]</span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>    steak_type <span class="ot">&lt;-</span> temp_and_type[<span class="dv">2</span>]</span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a>    <span class="cf">if</span>(steak_type <span class="sc">==</span> <span class="st">&quot;rare&quot;</span> <span class="sc">&amp;&amp;</span> temp <span class="sc">&gt;</span> <span class="dv">115</span>) {</span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a>        <span class="fu">return</span>(<span class="st">&quot;take your steak off!&quot;</span>)</span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span>(steak_type <span class="sc">==</span> <span class="st">&quot;med_rare&quot;</span> <span class="sc">&amp;&amp;</span> temp <span class="sc">&gt;</span> <span class="dv">125</span>) {</span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a>        <span class="fu">return</span>(<span class="st">&quot;take your steak off!&quot;</span>)        </span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a>    } </span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a>    <span class="st">&quot;you can keep cooking&quot;</span></span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a>}</span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a><span class="do">## this doesn&#39;t throw an error, but it also doesn&#39;t give the right output</span></span>
<span id="cb21-16"><a href="#cb21-16" tabindex="-1"></a><span class="fu">apply</span>(steak_combinations, <span class="dv">1</span>, steak_directions_for_apply)</span></code></pre></div>
<pre><code>## [1] &quot;take your steak off!&quot; &quot;take your steak off!&quot;</code></pre>
</div>
<div class="slide section level2">

<p>If you want to apply a function that uses columns of a data frame
that are of different types, better/safer to use
<code>mapply</code>:</p>
<p><code>mapply(FUN = f, vec1, vec2, ..., vecN)</code></p>
<ul class="incremental">
<li><p><code>f</code> is the function you want to apply</p></li>
<li><p>Output is a list, ith element will be
<code>f(vec1[i], vec2[i], ..., vecN[i])</code></p></li>
</ul>
</div>
<div class="slide section level2">

<div class="incremental">
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>steak_directions <span class="ot">&lt;-</span> <span class="cf">function</span>(steak_temp, steak_type) {</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>    <span class="cf">if</span>(steak_type <span class="sc">==</span> <span class="st">&quot;rare&quot;</span> <span class="sc">&amp;</span> steak_temp <span class="sc">&gt;</span> <span class="dv">115</span>) {</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>        <span class="fu">return</span>(<span class="st">&quot;take your steak off!&quot;</span>)</span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span>(steak_type <span class="sc">==</span> <span class="st">&quot;med_rare&quot;</span> <span class="sc">&amp;</span> steak_temp <span class="sc">&gt;</span> <span class="dv">125</span>) {</span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>        <span class="fu">return</span>(<span class="st">&quot;take your steak off!&quot;</span>)        </span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>    } </span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>    <span class="st">&quot;you can keep cooking&quot;</span></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>}</span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a><span class="fu">mapply</span>(<span class="at">FUN =</span> steak_directions, steak_combinations<span class="sc">$</span>temp, steak_combinations<span class="sc">$</span>type)</span></code></pre></div>
<pre><code>## [1] &quot;you can keep cooking&quot; &quot;you can keep cooking&quot;</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>steak_admonishments <span class="ot">&lt;-</span> <span class="cf">function</span>(steak_temp, steak_type) {</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>    <span class="cf">if</span>(steak_type <span class="sc">==</span> <span class="st">&quot;rare&quot;</span> <span class="sc">&amp;</span> steak_temp <span class="sc">&gt;</span> <span class="dv">115</span>) {</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>        admonishment <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;Your steak is overcooked by %i degrees!&quot;</span>, steak_temp <span class="sc">-</span> <span class="dv">115</span>)</span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>        <span class="fu">return</span>(admonishment)</span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span>(steak_type <span class="sc">==</span> <span class="st">&quot;med_rare&quot;</span> <span class="sc">&amp;</span> steak_temp <span class="sc">&gt;</span> <span class="dv">125</span>) {</span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a>        admonishment <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;Your steak is overcooked by %i degrees!&quot;</span>, steak_temp <span class="sc">-</span> <span class="dv">125</span>)</span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a>        <span class="fu">return</span>(admonishment)</span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a>    }</span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a>    <span class="st">&quot;Your steak is not overcooked yet.&quot;</span></span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a>}</span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a><span class="fu">mapply</span>(<span class="at">FUN =</span> steak_admonishments, steak_combinations<span class="sc">$</span>temp, steak_combinations<span class="sc">$</span>type)</span></code></pre></div>
<pre><code>## [1] &quot;Your steak is not overcooked yet.&quot; &quot;Your steak is not overcooked yet.&quot;</code></pre>
</div>
</div>
<div id="what-if-things-arent-quite-so-tidy"
class="slide section level2">
<h1>What if things aren’t quite so tidy?</h1>
<ul class="incremental">
<li><p>The <code>*apply</code> functions we’ve seen so far have applied
a function element-by-element to a vector or matrix.</p></li>
<li><p>What if we need to apply a function not to individual
elements/rows/columns, but to subsets of different sizes?</p></li>
</ul>
</div>
<div id="splitapplycombine-paradigm" class="slide section level2">
<h1>Split/apply/combine paradigm</h1>
<p>Turns out this is common enough that it has a name and a bunch of
built-in functions.</p>
<p>The programming pattern is pretty clear from the name, what we want
to do is:</p>
<ul class="incremental">
<li><p>split the data into groups</p></li>
<li><p>apply a function to each of the groups</p></li>
<li><p>combine the results of applying the function to each group into
an output dataset</p></li>
</ul>
</div>
<div id="why-is-this-a-useful-abstraction" class="slide section level2">
<h1>Why is this a useful abstraction?</h1>
<p>Imagine how you would do this if you only had for-loops.</p>
<p>You would have to first</p>
<ul class="incremental">
<li><p>Compute what size the output dataset should be</p></li>
<li><p>Create a data structure to hold the output.</p></li>
</ul>
<p>Then, for each level of the grouping factor:</p>
<ul class="incremental">
<li><p>Compute how many data elements correspond to that grouping
level</p></li>
<li><p>Create a data structure to hold the data subset</p></li>
<li><p>Loop through the data to extract the correct subset</p></li>
<li><p>Apply your function to that subset and put the output in the data
structure your created at the beginning.</p></li>
</ul>
</div>
<div class="slide section level2">

<p>Compare with split/apply/combine abstraction:</p>
<ul class="incremental">
<li><p>Specify data</p></li>
<li><p>Specify grouping variable for split</p></li>
<li><p>Specify function to apply to each split</p></li>
</ul>
<p>The abstraction is useful both for writing and reading the resulting
code: you think about <em>what</em> you want to do instead of
<em>how</em> to do it.</p>
</div>
<div id="splitapplycombine-for-vectors" class="slide section level2">
<h1>Split/apply/combine for vectors</h1>
<p>Simple case: we have a vector, and a grouping factor, we want to
apply a function to groups of elements of the vector defined by the
grouping factor</p>
<p>Solution is tapply</p>
<p><code>tapply(X = x, INDEX = f, FUN = fun)</code></p>
<p>Syntax:</p>
<ul class="incremental">
<li><p><code>x</code>: A vector with the data.</p></li>
<li><p><code>f</code>: A factor variable describing how the data should
be split up.</p></li>
<li><p><code>fun</code>: The function you want to apply to each subset
of the data.</p></li>
</ul>
</div>
<div class="slide section level2">

<p>Example: data on police stops in New York City in 1998–1999,
information on the number of stops as categorized by certain
variables.</p>
<p>In particular, we have counts of police stops for all combinations
of</p>
<ul class="incremental">
<li><p>precinct: 75 total</p></li>
<li><p>eth: Ethnicity of the person stopped, three possibilities,
and</p></li>
<li><p>crime: The type of crime, four possibilities</p></li>
</ul>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a>frisk <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;frisk_with_noise.dat&quot;</span>,</span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>                    <span class="at">skip =</span> <span class="dv">6</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a><span class="fu">head</span>(frisk)</span></code></pre></div>
<pre><code>##   stops  pop past.arrests precinct eth crime
## 1    75 1720          191        1   1     1
## 2    36 1720           57        1   1     2
## 3    74 1720          599        1   1     3
## 4    17 1720          133        1   1     4
## 5    37 1368           62        1   2     1
## 6    39 1368           27        1   2     2</code></pre>
</div>
<div class="slide section level2">

<p>Suppose we want to get the total number of stops in each
precinct.</p>
<p>We can use <code>tapply</code> with the <code>sum</code> function to
do so:</p>
<div class="incremental">
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="fu">tapply</span>(<span class="at">X =</span> frisk<span class="sc">$</span>stops, <span class="at">INDEX =</span> frisk<span class="sc">$</span>precinct, <span class="at">FUN =</span> sum)</span></code></pre></div>
<pre><code>##    1    2    3    4    5    6    7    8    9   10   11   12   13   14   15   16 
##  385  347 1603 1411 1600 1297  649 1572  285 1156  838  884 2215 1165 2373  965 
##   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32 
##  946 2359 1311 1566 1613 4030 2334 2622 3685 1541 2005  902 2888 2157 1805 1041 
##   33   34   35   36   37   38   39   40   41   42   43   44   45   46   47   48 
## 2966 2810  724 1189  997 1808 2464  859 1979 2679 1645 1669 2953 3443 1001 1574 
##   49   50   51   52   53   54   55   56   57   58   59   60   61   62   63   64 
## 1041 3054 1208 2116 1216  995 1140  572  856 2671 1147 2941 1625 1635 1248 1351 
##   65   66   67   68   69   70   71   72   73   74   75 
## 2290 2941 2430 1109 1267 2476 2922 3560 3650 1327  322</code></pre>
<p>Just as a check, make sure that the numbers match up:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a>precinct_1 <span class="ot">&lt;-</span> <span class="fu">subset</span>(frisk, precinct <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a><span class="fu">sum</span>(precinct_1<span class="sc">$</span>stops)</span></code></pre></div>
<pre><code>## [1] 385</code></pre>
</div>
</div>
<div class="slide section level2">

<p>And remember how much better this is than iterating using a for loop
would have been:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a><span class="do">## find the number of precincts and make a vector of the right length to store the output</span></span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a>precincts <span class="ot">&lt;-</span> <span class="fu">unique</span>(frisk<span class="sc">$</span>precinct)</span>
<span id="cb33-3"><a href="#cb33-3" tabindex="-1"></a>stops_per_precinct <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(precincts))</span>
<span id="cb33-4"><a href="#cb33-4" tabindex="-1"></a><span class="do">## iterate over precinct, get the subset for each one, compute the number of stops, and store</span></span>
<span id="cb33-5"><a href="#cb33-5" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(precincts)) {</span>
<span id="cb33-6"><a href="#cb33-6" tabindex="-1"></a>    precinct_subset <span class="ot">&lt;-</span> <span class="fu">subset</span>(frisk, precinct <span class="sc">==</span> precincts[i])</span>
<span id="cb33-7"><a href="#cb33-7" tabindex="-1"></a>    precinct_stops <span class="ot">&lt;-</span> <span class="fu">sum</span>(precinct_subset<span class="sc">$</span>stops)</span>
<span id="cb33-8"><a href="#cb33-8" tabindex="-1"></a>    stops_per_precinct[i] <span class="ot">&lt;-</span> precinct_stops</span>
<span id="cb33-9"><a href="#cb33-9" tabindex="-1"></a>}</span>
<span id="cb33-10"><a href="#cb33-10" tabindex="-1"></a>stops_per_precinct</span></code></pre></div>
<pre><code>##  [1]  385  347 1603 1411 1600 1297  649 1572  285 1156  838  884 2215 1165 2373
## [16]  965  946 2359 1311 1566 1613 4030 2334 2622 3685 1541 2005  902 2888 2157
## [31] 1805 1041 2966 2810  724 1189  997 1808 2464  859 1979 2679 1645 1669 2953
## [46] 3443 1001 1574 1041 3054 1208 2116 1216  995 1140  572  856 2671 1147 2941
## [61] 1625 1635 1248 1351 2290 2941 2430 1109 1267 2476 2922 3560 3650 1327  322</code></pre>
</div>
<div id="splitapplycombine-for-data-frames"
class="slide section level2">
<h1>Split/apply/combine for data frames</h1>
<p>Splitting a data frame into groups of rows and applying a function to
the groups:</p>
<p><code>by(data = df, INDICES = fact, FUN = fun)</code></p>
<ul class="incremental">
<li><p><code>df</code>: A data frame containing the data you want to
split up and apply a function to.</p></li>
<li><p><code>fact</code>: A factor variable describing the groups you
want to split <code>df</code> into.</p></li>
<li><p><code>fun</code>: The function you want to apply to each group.
It should take as its first argument a data frame.</p></li>
</ul>
</div>
<div class="slide section level2">

<div class="incremental">
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a>stops_and_past_arrests_correlation <span class="ot">&lt;-</span> <span class="cf">function</span>(frisk_subset) {</span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a>    <span class="fu">cor</span>(frisk_subset<span class="sc">$</span>stops, frisk_subset<span class="sc">$</span>past.arrests)</span>
<span id="cb35-3"><a href="#cb35-3" tabindex="-1"></a>}</span>
<span id="cb35-4"><a href="#cb35-4" tabindex="-1"></a>within_precinct_cors <span class="ot">&lt;-</span> <span class="fu">by</span>(<span class="at">data =</span> frisk,</span>
<span id="cb35-5"><a href="#cb35-5" tabindex="-1"></a>                           <span class="at">INDICES =</span> frisk<span class="sc">$</span>precinct,</span>
<span id="cb35-6"><a href="#cb35-6" tabindex="-1"></a>                           <span class="at">FUN =</span> stops_and_past_arrests_correlation)</span>
<span id="cb35-7"><a href="#cb35-7" tabindex="-1"></a><span class="fu">head</span>(within_precinct_cors)</span></code></pre></div>
<pre><code>## frisk$precinct
##           1           2           3           4           5           6 
##  0.60479730  0.01659348 -0.21949242  0.12046523 -0.06892661  0.54151306</code></pre>
</div>
</div>
<div id="anonymous-functions" class="slide section level2">
<h1>Anonymous functions</h1>
<div class="incremental">
<p>Here we only need the <code>stops_and_past_arrests_correlation</code>
function in the context of <code>by</code>, so there’s no need to define
it in the global environment.</p>
<p>Instead we can specify it as an anonymous function:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a>within_precinct_cors <span class="ot">&lt;-</span> <span class="fu">by</span>(<span class="at">data =</span> frisk,</span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a>                           <span class="at">INDICES =</span> frisk<span class="sc">$</span>precinct,</span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a>                           <span class="at">FUN =</span> <span class="cf">function</span>(frisk_subset) {</span>
<span id="cb37-4"><a href="#cb37-4" tabindex="-1"></a>                               <span class="fu">cor</span>(frisk_subset<span class="sc">$</span>stops, frisk_subset<span class="sc">$</span>past.arrests)</span>
<span id="cb37-5"><a href="#cb37-5" tabindex="-1"></a>                           })</span>
<span id="cb37-6"><a href="#cb37-6" tabindex="-1"></a><span class="fu">head</span>(within_precinct_cors)</span></code></pre></div>
<pre><code>## frisk$precinct
##           1           2           3           4           5           6 
##  0.60479730  0.01659348 -0.21949242  0.12046523 -0.06892661  0.54151306</code></pre>
</div>
</div>
<div class="slide section level2">

<p>A more complex example:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a><span class="fu">data</span>(diamonds)</span>
<span id="cb39-2"><a href="#cb39-2" tabindex="-1"></a>get_diamond_coefficients <span class="ot">&lt;-</span> <span class="cf">function</span>(data_subset) {</span>
<span id="cb39-3"><a href="#cb39-3" tabindex="-1"></a>    diamond_lm <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">log</span>(price) <span class="sc">~</span> carat, <span class="at">data =</span> data_subset)</span>
<span id="cb39-4"><a href="#cb39-4" tabindex="-1"></a>    diamond_coefficients <span class="ot">&lt;-</span> <span class="fu">coef</span>(diamond_lm)</span>
<span id="cb39-5"><a href="#cb39-5" tabindex="-1"></a>    <span class="fu">return</span>(diamond_coefficients)</span>
<span id="cb39-6"><a href="#cb39-6" tabindex="-1"></a>}</span>
<span id="cb39-7"><a href="#cb39-7" tabindex="-1"></a><span class="do">## by does the split and apply steps, and an ugly version of a combine step</span></span>
<span id="cb39-8"><a href="#cb39-8" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">by</span>(<span class="at">data =</span> diamonds, <span class="at">INDICES =</span> diamonds<span class="sc">$</span>color, <span class="at">FUN =</span> get_diamond_coefficients)</span></code></pre></div>
</div>
<div class="slide section level2">

<p>The output is as a list with some extra attributes (the class is
<code>by</code>, as you can check).</p>
<p>The form is not ideal on its own, usually you’ll want to simplify it.
You have a couple of options, including the examples below:</p>
<div class="incremental">
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a><span class="fu">simplify2array</span>(out)</span></code></pre></div>
<pre><code>##                    D        E        F        G        H        I        J
## (Intercept) 6.048811 6.034513 6.088442 6.109554 6.180284 6.175315 6.254074
## carat       2.383864 2.348335 2.272790 2.178489 1.906300 1.799199 1.627947</code></pre>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a><span class="do">## changing the output from a list to a matrix</span></span>
<span id="cb42-2"><a href="#cb42-2" tabindex="-1"></a><span class="fu">do.call</span>(rbind, out)</span></code></pre></div>
<pre><code>##   (Intercept)    carat
## D    6.048811 2.383864
## E    6.034513 2.348335
## F    6.088442 2.272790
## G    6.109554 2.178489
## H    6.180284 1.906300
## I    6.175315 1.799199
## J    6.254074 1.627947</code></pre>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a><span class="do">## it&#39;s kind of bad that the splitting variable is only available as row names</span></span>
<span id="cb44-2"><a href="#cb44-2" tabindex="-1"></a><span class="do">## we can fix that but it&#39;s a bit of a pain</span></span>
<span id="cb44-3"><a href="#cb44-3" tabindex="-1"></a>diamond_coef_matrix <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, out)</span>
<span id="cb44-4"><a href="#cb44-4" tabindex="-1"></a>diamond_coef_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(diamond_coef_matrix,</span>
<span id="cb44-5"><a href="#cb44-5" tabindex="-1"></a>                              <span class="at">color =</span> <span class="fu">attributes</span>(out)<span class="sc">$</span>dimnames<span class="sc">$</span><span class="st">`</span><span class="at">diamonds$color</span><span class="st">`</span>)</span>
<span id="cb44-6"><a href="#cb44-6" tabindex="-1"></a>diamond_coef_df</span></code></pre></div>
<pre><code>##   X.Intercept.    carat color
## D     6.048811 2.383864     D
## E     6.034513 2.348335     E
## F     6.088442 2.272790     F
## G     6.109554 2.178489     G
## H     6.180284 1.906300     H
## I     6.175315 1.799199     I
## J     6.254074 1.627947     J</code></pre>
</div>
</div>
<div class="slide section level2">

<p><code>by</code> can also be used with multiple grouping factors:</p>
<div class="incremental">
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" tabindex="-1"></a><span class="fu">by</span>(<span class="at">data =</span> diamonds, <span class="at">INDICES =</span> diamonds[, <span class="fu">c</span>(<span class="st">&quot;color&quot;</span>, <span class="st">&quot;cut&quot;</span>)], <span class="at">FUN =</span> get_diamond_coefficients)</span></code></pre></div>
<pre><code>## color: D
## cut: Fair
## (Intercept)       carat 
##    6.723804    1.514938 
## ------------------------------------------------------------ 
## color: E
## cut: Fair
## (Intercept)       carat 
##    6.246003    1.955816 
## ------------------------------------------------------------ 
## color: F
## cut: Fair
## (Intercept)       carat 
##    6.466073    1.637304 
## ------------------------------------------------------------ 
## color: G
## cut: Fair
## (Intercept)       carat 
##    6.659407    1.358722 
## ------------------------------------------------------------ 
## color: H
## cut: Fair
## (Intercept)       carat 
##    6.921231    1.122101 
## ------------------------------------------------------------ 
## color: I
## cut: Fair
## (Intercept)       carat 
##    6.759325    1.202279 
## ------------------------------------------------------------ 
## color: J
## cut: Fair
## (Intercept)       carat 
##   7.0504140   0.8761416 
## ------------------------------------------------------------ 
## color: D
## cut: Good
## (Intercept)       carat 
##    5.925962    2.415309 
## ------------------------------------------------------------ 
## color: E
## cut: Good
## (Intercept)       carat 
##    5.976449    2.322896 
## ------------------------------------------------------------ 
## color: F
## cut: Good
## (Intercept)       carat 
##    6.016284    2.273226 
## ------------------------------------------------------------ 
## color: G
## cut: Good
## (Intercept)       carat 
##    6.180670    2.037179 
## ------------------------------------------------------------ 
## color: H
## cut: Good
## (Intercept)       carat 
##    6.106822    1.952841 
## ------------------------------------------------------------ 
## color: I
## cut: Good
## (Intercept)       carat 
##    6.182043    1.762664 
## ------------------------------------------------------------ 
## color: J
## cut: Good
## (Intercept)       carat 
##    6.133176    1.728532 
## ------------------------------------------------------------ 
## color: D
## cut: Very Good
## (Intercept)       carat 
##    5.953898    2.487391 
## ------------------------------------------------------------ 
## color: E
## cut: Very Good
## (Intercept)       carat 
##    5.909810    2.480529 
## ------------------------------------------------------------ 
## color: F
## cut: Very Good
## (Intercept)       carat 
##    5.947350    2.446917 
## ------------------------------------------------------------ 
## color: G
## cut: Very Good
## (Intercept)       carat 
##    5.965330    2.343517 
## ------------------------------------------------------------ 
## color: H
## cut: Very Good
## (Intercept)       carat 
##    6.110954    1.993643 
## ------------------------------------------------------------ 
## color: I
## cut: Very Good
## (Intercept)       carat 
##    6.207955    1.807934 
## ------------------------------------------------------------ 
## color: J
## cut: Very Good
## (Intercept)       carat 
##    6.211086    1.696800 
## ------------------------------------------------------------ 
## color: D
## cut: Premium
## (Intercept)       carat 
##    6.109571    2.258907 
## ------------------------------------------------------------ 
## color: E
## cut: Premium
## (Intercept)       carat 
##    6.133275    2.185096 
## ------------------------------------------------------------ 
## color: F
## cut: Premium
## (Intercept)       carat 
##    6.189666    2.124037 
## ------------------------------------------------------------ 
## color: G
## cut: Premium
## (Intercept)       carat 
##    6.181514    2.052932 
## ------------------------------------------------------------ 
## color: H
## cut: Premium
## (Intercept)       carat 
##    6.270586    1.809367 
## ------------------------------------------------------------ 
## color: I
## cut: Premium
## (Intercept)       carat 
##    6.229239    1.723257 
## ------------------------------------------------------------ 
## color: J
## cut: Premium
## (Intercept)       carat 
##    6.305114    1.578440 
## ------------------------------------------------------------ 
## color: D
## cut: Ideal
## (Intercept)       carat 
##    5.970971    2.626088 
## ------------------------------------------------------------ 
## color: E
## cut: Ideal
## (Intercept)       carat 
##    5.989833    2.526368 
## ------------------------------------------------------------ 
## color: F
## cut: Ideal
## (Intercept)       carat 
##    6.052536    2.408753 
## ------------------------------------------------------------ 
## color: G
## cut: Ideal
## (Intercept)       carat 
##    6.032829    2.367710 
## ------------------------------------------------------------ 
## color: H
## cut: Ideal
## (Intercept)       carat 
##    6.075676    2.071994 
## ------------------------------------------------------------ 
## color: I
## cut: Ideal
## (Intercept)       carat 
##    6.071246    1.932255 
## ------------------------------------------------------------ 
## color: J
## cut: Ideal
## (Intercept)       carat 
##    6.104631    1.784315</code></pre>
<p>But how do you get at which coefficients correspond to which factor
groups?</p>
</div>
</div>
<div id="if-you-want-to-do-split-and-applycombine-separately"
class="slide section level2">
<h1>If you want to do split and apply/combine separately</h1>
<p><code>split</code> does just the splitting part of
split/apply/combine</p>
<p>Syntax: <code>split(x = data, f = fact)</code></p>
<ul class="incremental">
<li><p><code>data</code>: Your data, either a vector or a data frame,
that you want to divide into groups.</p></li>
<li><p><code>fact</code>: A factor variable used to split
<code>data</code>. Length is equal to the length of <code>dat</code> if
it is a vector or equal to the number of rows of <code>data</code> if it
is a data frame.</p></li>
</ul>
<p>Output:</p>
<ul class="incremental">
<li><p>A list of length equal to the number of levels in
<code>fact</code></p></li>
<li><p>Each element of the list is either a vector or a data frame,
depending on what <code>data</code> was, containing the elements of
<code>data</code> corresponding to one of the levels of
<code>fact</code>.</p></li>
</ul>
</div>
<div class="slide section level2">

<p>We can re-do the stop-and-frisk example that we used
<code>tapply</code> for with <code>split</code> followed by
<code>lapply</code> or <code>sapply</code></p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a>frisk_split_by_precinct <span class="ot">&lt;-</span> <span class="fu">split</span>(<span class="at">x =</span> frisk<span class="sc">$</span>stops, <span class="at">f =</span> frisk<span class="sc">$</span>precinct)</span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a><span class="do">## check that this has length 75, the number of precincts</span></span>
<span id="cb48-3"><a href="#cb48-3" tabindex="-1"></a><span class="fu">length</span>(frisk_split_by_precinct)</span></code></pre></div>
<pre><code>## [1] 75</code></pre>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" tabindex="-1"></a><span class="fu">sapply</span>(frisk_split_by_precinct, sum)</span></code></pre></div>
<pre><code>##    1    2    3    4    5    6    7    8    9   10   11   12   13   14   15   16 
##  385  347 1603 1411 1600 1297  649 1572  285 1156  838  884 2215 1165 2373  965 
##   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32 
##  946 2359 1311 1566 1613 4030 2334 2622 3685 1541 2005  902 2888 2157 1805 1041 
##   33   34   35   36   37   38   39   40   41   42   43   44   45   46   47   48 
## 2966 2810  724 1189  997 1808 2464  859 1979 2679 1645 1669 2953 3443 1001 1574 
##   49   50   51   52   53   54   55   56   57   58   59   60   61   62   63   64 
## 1041 3054 1208 2116 1216  995 1140  572  856 2671 1147 2941 1625 1635 1248 1351 
##   65   66   67   68   69   70   71   72   73   74   75 
## 2290 2941 2430 1109 1267 2476 2922 3560 3650 1327  322</code></pre>
</div>
<div class="slide section level2">

<p>In general, base R apply-family functions don’t produce nice output
from the combine step.</p>
<p>We’ll see implementations of split/apply/combine next time that do a
nicer job.</p>
</div>
</body>
</html>
