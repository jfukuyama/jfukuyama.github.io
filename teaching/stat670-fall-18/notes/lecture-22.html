<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Julia Fukuyama" />
  <title>Stat 470/670 Lecture 22: Logistic regression with many predictors</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
  </style>
  <link rel="stylesheet" type="text/css" media="screen, projection, print"
    href="http://www.w3.org/Talks/Tools/Slidy2/styles/slidy.css" />
  <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
  <script src="http://www.w3.org/Talks/Tools/Slidy2/scripts/slidy.js"
    charset="utf-8" type="text/javascript"></script>
</head>
<body>
<div class="slide titlepage">
  <h1 class="title">Stat 470/670 Lecture 22: Logistic regression with many predictors</h1>
  <p class="author">
Julia Fukuyama
  </p>
  <p class="date">November 1, 2018</p>
</div>
<div id="arsenic-in-wells" class="slide section level1">
<h1>Arsenic in wells</h1>
<p>The file <code>wells.dat</code> contains data on 3,020 households in Bangladesh whose wells had arsenic levels above the national drinking water standard of 50 micrograms per liter. The variables are:</p>
<ul>
<li><p><code>switch</code>: the response: whether or not the household switched after being encouraged to do so (after high arsenic was measured.)</p></li>
<li><p><code>arsenic</code>: the arsenic concentration in hundreds of micrograms per liter.</p></li>
<li><p><code>dist</code>: the distance to the nearest safe well in meters.</p></li>
<li><p><code>assoc</code>: whether anyone in the household is in a community association.</p></li>
<li><p><code>educ</code>: the years of education of the head of the household.</p></li>
</ul>
</div>
<div class="slide section level1">

<p>We load at the data and look at the numerical summary and a pairs plot:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(GGally)
wells =<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;../../datasets/wells.dat&quot;</span>)
<span class="kw">summary</span>(wells)</code></pre>
<pre><code>##      switch          arsenic           dist             assoc       
##  Min.   :0.0000   Min.   :0.510   Min.   :  0.387   Min.   :0.0000  
##  1st Qu.:0.0000   1st Qu.:0.820   1st Qu.: 21.117   1st Qu.:0.0000  
##  Median :1.0000   Median :1.300   Median : 36.761   Median :0.0000  
##  Mean   :0.5752   Mean   :1.657   Mean   : 48.332   Mean   :0.4228  
##  3rd Qu.:1.0000   3rd Qu.:2.200   3rd Qu.: 64.041   3rd Qu.:1.0000  
##  Max.   :1.0000   Max.   :9.650   Max.   :339.531   Max.   :1.0000  
##       educ       
##  Min.   : 0.000  
##  1st Qu.: 0.000  
##  Median : 5.000  
##  Mean   : 4.828  
##  3rd Qu.: 8.000  
##  Max.   :17.000</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggpairs</span>(wells)</code></pre>
<div class="figure">
<img src="lecture-22-fig/unnamed-chunk-1-1.png" />
</div>
<p>As we might expect, distance and education level are positively associated with switching, while arsenic level is negatively associated. Surprisingly, the correlation between belong to an association and switching is negative, though the relationship is very weak.</p>
</div>
<div class="slide section level1">

<p>Distance and arsenic levels should be the best predictors, so let's look more closely at the distributions of those variables.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(wells, <span class="kw">aes</span>(<span class="dt">x =</span> dist)) +
<span class="st">    </span><span class="kw">geom_histogram</span>(<span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">340</span>, <span class="dv">10</span>)) +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Distance to nearest safe well (meters)&quot;</span>)</code></pre>
<div class="figure">
<img src="lecture-22-fig/unnamed-chunk-2-1.png" />
</div>
<p>We see the distribution of distance peaks around 40--60 meters, then is strongly right-skewed. We should keep the possibility of a transformation in mind.</p>
</div>
<div class="slide section level1">

<p>Then arsenic:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(wells, <span class="kw">aes</span>(<span class="dt">x =</span> arsenic)) +
<span class="st">    </span><span class="kw">geom_histogram</span>(<span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="fl">0.25</span>)) +<span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;Arsenic concentration (100 mg/liter)&quot;</span>)</code></pre>
<div class="figure">
<img src="lecture-22-fig/unnamed-chunk-3-1.png" />
</div>
<p>There are no observations with arsenic below 0.5, because these are considered &quot;safe&quot; and the households don't get advised to switch wells. Otherwise, the distribution is against strongly right-skewed, suggesting a transformation.</p>
<p>Note that the scales of <code>dist</code> and <code>arsenic</code> are quite different. Some authors suggest standardizing the data for interpretability, so that predictors are on approximately the same scale. That's not a bad idea but we will hold off for now.</p>
</div>
<div class="slide section level1">

<p>And finally education:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(wells, <span class="kw">aes</span>(<span class="dt">x =</span> educ)) +<span class="st"> </span><span class="kw">geom_histogram</span>(<span class="dt">breaks =</span> -<span class="fl">0.5</span>:<span class="fl">17.5</span>) +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Years of education&quot;</span>)</code></pre>
<div class="figure">
<img src="lecture-22-fig/unnamed-chunk-4-1.png" />
</div>
<p>The distribution is weird. 0 (no education) and 5 (primary school only) are the magic numbers.</p>
</div>
<div id="starting-off-simple" class="slide section level1">
<h1>Starting off simple</h1>
<p>One way of approaching EDA is to throw everything into your model and then get rid of terms you don't need. Another strategy is to start with simple models and gradually build up to complex models. Let's take this second approach for now.</p>
<p>We'll start by predicting switching, using distance as the only response. There's no reason why we can't try loess:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(wells, <span class="kw">aes</span>(<span class="dt">x =</span> dist, <span class="dt">y =</span> switch)) +
<span class="st">    </span><span class="kw">geom_jitter</span>(<span class="dt">width =</span> <span class="dv">0</span>, <span class="dt">height =</span> <span class="fl">0.1</span>) +
<span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;loess&quot;</span>) +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Distance from nearest safe well&quot;</span>) +
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Probability of switching&quot;</span>)</code></pre>
<div class="figure">
<img src="lecture-22-fig/unnamed-chunk-5-1.png" />
</div>
<p>We can interpret the fit as the probability of switching wells, given the distance to the nearest safe well. There's a bump for very low distances (which is probably just noise) and then a decline. We could play around with the smoothing parameters to get something more pleasant-looking. Instead, we'll fit a logistic regression to guarantee a decreasing relationship.</p>
</div>
<div class="slide section level1">

<pre class="sourceCode r"><code class="sourceCode r">gg =<span class="st"> </span><span class="kw">ggplot</span>(wells, <span class="kw">aes</span>(<span class="dt">x =</span> dist, <span class="dt">y =</span> switch)) +
<span class="st">    </span><span class="kw">geom_jitter</span>(<span class="dt">width =</span> <span class="dv">0</span>, <span class="dt">height =</span> <span class="fl">0.1</span>) +
<span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;loess&quot;</span>)
gg +<span class="st"> </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;glm&quot;</span>, <span class="dt">method.args =</span> <span class="kw">list</span>(<span class="dt">family =</span> <span class="st">&quot;binomial&quot;</span>), <span class="dt">color =</span> <span class="st">&quot;orange&quot;</span>) +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Distance from nearest safe well&quot;</span>) +
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Probability of switching&quot;</span>)</code></pre>
<div class="figure">
<img src="lecture-22-fig/unnamed-chunk-6-1.png" />
</div>
<p>The parametric method imposes a functional form on the data. This aids in interpretability: the fit can now be described in a couple of parameters, and the weird bump at the beginning is gone. The cost is some lack of fit: perhaps the probability should decrease more quickly as the distance gets beyond about 60 meters (remember that water is heavy and it's tiring to carry buckets back and forth over long distances.)</p>
</div>
<div class="slide section level1">

<p>Let's try the same kind of approach using arsenic concentration as the sole predictor.</p>
<pre class="sourceCode r"><code class="sourceCode r">gg =<span class="st"> </span><span class="kw">ggplot</span>(wells, <span class="kw">aes</span>(<span class="dt">x =</span> arsenic, <span class="dt">y =</span> switch)) +
<span class="st">    </span><span class="kw">geom_jitter</span>(<span class="dt">width =</span> <span class="dv">0</span>, <span class="dt">height =</span> <span class="fl">0.1</span>) +
<span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;loess&quot;</span>)
gg +<span class="st"> </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;glm&quot;</span>, <span class="dt">method.args =</span> <span class="kw">list</span>(<span class="dt">family =</span> <span class="st">&quot;binomial&quot;</span>), <span class="dt">color =</span> <span class="st">&quot;orange&quot;</span>) +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Arsenic concentration&quot;</span>) +
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Probability of switching&quot;</span>)</code></pre>
<div class="figure">
<img src="lecture-22-fig/unnamed-chunk-7-1.png" />
</div>
<p>The fits diverge at arsenic levels above about 5. The seems to be because of a couple of extremely high arsenic observations which led to switching. Note however that not much of the data has arsenic above 5, so it remains to be seen how much this matters.</p>
<p>Also note the difference in fits for low levels of arsenic. This is more worrisome than the difference at high levels because there is actually a lot of data there. It seems likely that there is a lack of fit for the low concentrations that logistic regression can't handle. We'll come back to this later.</p>
</div>
<div id="two-predictors" class="slide section level1">
<h1>Two predictors</h1>
<p>We now want to know how the chance of switching depends on distance and arsenic simulataneously. Before fitting a model, we plot the data to get a feel for it. We'll use color to distinguish between households that switch and households that don't.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(wells, <span class="kw">aes</span>(<span class="dt">x =</span> dist, <span class="dt">y =</span> arsenic, <span class="dt">color =</span> <span class="kw">factor</span>(switch))) +
<span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.5</span>) +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Distance from nearest safe well&quot;</span>) +
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Arsenic concentration&quot;</span>) +
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">color =</span> <span class="st">&quot;Did they switch?&quot;</span>) +
<span class="st">    </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#E69F00&quot;</span>, <span class="st">&quot;#56B4E9&quot;</span>), <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;No&quot;</span>, <span class="st">&quot;Yes&quot;</span>))</code></pre>
<div class="figure">
<img src="lecture-22-fig/unnamed-chunk-8-1.png" />
</div>
<p>The <code>alpha = 0.5</code> makes the points slightly transparent, which can help visually when you have a lot of data. Still, it's hard to work out how switching depends on the other two variables from this graph; that's why we're fitting a model. The main thing to take home from the graph is the lack of data in the top right: we have no observations at all with both distance above 200 and arsenic above 4, so we should not try to generalize to this region.</p>
</div>
<div class="slide section level1">

<p>Density plots are actually more useful for comparing the two distributions, and we can use <code>geom_density2d</code> to make such a plot:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(wells, <span class="kw">aes</span>(<span class="dt">x =</span> dist, <span class="dt">y =</span> arsenic, <span class="dt">color =</span> <span class="kw">factor</span>(switch))) +
<span class="st">    </span><span class="kw">geom_density2d</span>() +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Distance from nearest safe well&quot;</span>) +
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Arsenic concentration&quot;</span>) +
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">color =</span> <span class="st">&quot;Did they switch?&quot;</span>) +
<span class="st">    </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#E69F00&quot;</span>, <span class="st">&quot;#56B4E9&quot;</span>), <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;No&quot;</span>, <span class="st">&quot;Yes&quot;</span>))</code></pre>
<div class="figure">
<img src="lecture-22-fig/unnamed-chunk-9-1.png" />
</div>
<p>We see here that people who didn't switch tend to be at lower arsenic levels and larger distances from the nearest safe well, which makes sense.</p>
</div>
<div class="slide section level1">

<p>Now we'll fit a logistic regression using both distance and arsenic as predictors. We first fit an additive model, i.e. with no interaction.</p>
<pre class="sourceCode r"><code class="sourceCode r">switch.logit =<span class="st"> </span><span class="kw">glm</span>(switch ~<span class="st"> </span>dist +<span class="st"> </span>arsenic, <span class="dt">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="dt">data =</span> wells)
<span class="kw">summary</span>(switch.logit)</code></pre>
<pre><code>## 
## Call:
## glm(formula = switch ~ dist + arsenic, family = &quot;binomial&quot;, data = wells)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -2.6351  -1.2139   0.7786   1.0702   1.7085  
## 
## Coefficients:
##              Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)  0.002749   0.079448   0.035    0.972    
## dist        -0.008966   0.001043  -8.593   &lt;2e-16 ***
## arsenic      0.460775   0.041385  11.134   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 4118.1  on 3019  degrees of freedom
## Residual deviance: 3930.7  on 3017  degrees of freedom
## AIC: 3936.7
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<p>As always, the coefficients are the most important things here. According to the model,</p>
<p><span class="math">\[
\textrm{logit}[P(\textrm{switch}|{\textrm{dist, arsenic}})] = 0.003 - 0.00897 \times \textrm{dist} + 0.4608 \times \textrm{arsenic}.
\]</span></p>
</div>
<div class="slide section level1">

<p>As in the continuous case, we visualize the fit by drawing multiple curves representing different values of one of the predictors. Let's display the switching probability as a function of distance for a few values of arsenic. Note that when we use the <code>augment()</code> function, we specify <code>type.predict = &quot;response&quot;</code> to get the probabilities and not their logits.</p>
<pre class="sourceCode r"><code class="sourceCode r">dist_df =<span class="st"> </span><span class="kw">expand.grid</span>(<span class="dt">dist =</span> <span class="dv">0</span>:<span class="dv">339</span>, <span class="dt">arsenic =</span> <span class="kw">seq</span>(<span class="fl">0.5</span>, <span class="fl">2.5</span>, <span class="fl">0.5</span>))
dist_preds =<span class="st"> </span><span class="kw">augment</span>(switch.logit, <span class="dt">type.predict =</span> <span class="st">&quot;response&quot;</span>, <span class="dt">newdata =</span> dist_df)
<span class="kw">ggplot</span>(dist_preds, <span class="kw">aes</span>(<span class="dt">x =</span> dist, <span class="dt">y =</span> .fitted, <span class="dt">group =</span> arsenic, <span class="dt">color =</span> arsenic)) +
<span class="st">    </span><span class="kw">geom_line</span>() +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Distance from nearest safe well&quot;</span>) +
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Probability of switching&quot;</span>) +
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">color =</span> <span class="st">&quot;Arsenic concentration&quot;</span>) +
<span class="st">    </span><span class="kw">scale_color_viridis</span>()</code></pre>
<div class="figure">
<img src="lecture-22-fig/unnamed-chunk-11-1.png" />
</div>
<p>The median arsenic level is 1.3. If arsenic is near the median, the probability of switching declines from 60-something percent if you're right by a safe well to less than 10% if the nearest safe well is hundreds of meters away.</p>
</div>
<div class="slide section level1">

<p>Now find prediction curves for arsenic for a few different distances:</p>
<pre class="sourceCode r"><code class="sourceCode r">arsenic_df =<span class="st"> </span><span class="kw">expand.grid</span>(<span class="dt">arsenic =</span> <span class="kw">seq</span>(<span class="fl">0.5</span>, <span class="dv">10</span>, <span class="fl">0.01</span>), <span class="dt">dist =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="dv">25</span>))
arsenic_pred =<span class="st"> </span><span class="kw">augment</span>(switch.logit, <span class="dt">type.predict =</span> <span class="st">&quot;response&quot;</span>, <span class="dt">newdata =</span> arsenic_df)
<span class="kw">ggplot</span>(arsenic_pred, <span class="kw">aes</span>(<span class="dt">x =</span> arsenic, <span class="dt">y =</span> .fitted, <span class="dt">group =</span> dist, <span class="dt">color =</span> dist)) +
<span class="st">    </span><span class="kw">geom_line</span>() +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Arsenic concentration&quot;</span>) +
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Probability of switching&quot;</span>) +
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">color =</span> <span class="st">&quot;Distance from nearest safe well&quot;</span>) +<span class="st"> </span><span class="kw">scale_color_viridis</span>()</code></pre>
<div class="figure">
<img src="lecture-22-fig/unnamed-chunk-12-1.png" />
</div>
<p>The median distance to a safe well is about 37 meters. At that distance, if the arsenic level is only just over the safety threshold, it's about 50--50 whether a household switched. On the other hand, at the highest levels of arsenic, households will almost certainly switch even if the nearest safe well is quite far.</p>
</div>
<div id="adding-an-interaction" class="slide section level1">
<h1>Adding an interaction</h1>
<p>We now add an interaction term between distance and arsenic.</p>
<pre class="sourceCode r"><code class="sourceCode r">switch_int =<span class="st"> </span><span class="kw">glm</span>(switch ~<span class="st"> </span>dist *<span class="st"> </span>arsenic, <span class="dt">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="dt">data =</span> wells)
<span class="kw">summary</span>(switch_int)</code></pre>
<pre><code>## 
## Call:
## glm(formula = switch ~ dist * arsenic, family = &quot;binomial&quot;, data = wells)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -2.7823  -1.2004   0.7696   1.0816   1.8476  
## 
## Coefficients:
##               Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)  -0.147868   0.117538  -1.258  0.20838    
## dist         -0.005772   0.002092  -2.759  0.00579 ** 
## arsenic       0.555977   0.069319   8.021 1.05e-15 ***
## dist:arsenic -0.001789   0.001023  -1.748  0.08040 .  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 4118.1  on 3019  degrees of freedom
## Residual deviance: 3927.6  on 3016  degrees of freedom
## AIC: 3935.6
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<p>The numbers are a bit hard to interpret. For example, the sign of the interaction term is negative, but it's hard to know exactly what this means (especially since the signs for distance and arsenic go in different directions.) The interpretation is easier if we just plot curves.</p>
<pre class="sourceCode r"><code class="sourceCode r">dist_int =<span class="st"> </span><span class="kw">augment</span>(switch_int, <span class="dt">type.predict =</span> <span class="st">&quot;response&quot;</span>, <span class="dt">newdata =</span> dist_df)
<span class="kw">ggplot</span>(dist_int, <span class="kw">aes</span>(<span class="dt">x =</span> dist, <span class="dt">y =</span> .fitted, <span class="dt">group =</span> arsenic, <span class="dt">color =</span> arsenic)) +
<span class="st">    </span><span class="kw">geom_line</span>() +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Distance from nearest safe well&quot;</span>) +
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Probability of switching&quot;</span>) +
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">color =</span> <span class="st">&quot;Arsenic concentration&quot;</span>) +<span class="st"> </span><span class="kw">scale_color_viridis</span>()</code></pre>
<div class="figure">
<img src="lecture-22-fig/unnamed-chunk-14-1.png" />
</div>
<p>The interaction brings the curves together as distance increases. If the nearest safe well is close, it makes a big difference whether the arsenic concentration is just over the limit or much bigger. If the nearest safe well is far, it makes little difference: people are unlikely to switch no matter the concentration. The curves meet up beyond 300 meters, though we only have three observations where the distance exceeds 300 meters.</p>
<pre class="sourceCode r"><code class="sourceCode r">arsenic_int_pred =<span class="st"> </span><span class="kw">augment</span>(switch_int, <span class="dt">type.predict =</span> <span class="st">&quot;response&quot;</span>, <span class="dt">newdata =</span> arsenic_df)
<span class="kw">ggplot</span>(arsenic_int_pred, <span class="kw">aes</span>(<span class="dt">x =</span> arsenic, <span class="dt">y =</span> .fitted, <span class="dt">group =</span> dist, <span class="dt">color =</span> dist)) +
<span class="st">    </span><span class="kw">geom_line</span>() +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Arsenic concentration&quot;</span>) +
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Probability of switching&quot;</span>) +
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">color =</span> <span class="st">&quot;Distance from nearest safe well&quot;</span>) +<span class="st"> </span><span class="kw">scale_color_viridis</span>()</code></pre>
<div class="figure">
<img src="lecture-22-fig/unnamed-chunk-15-1.png" />
</div>
<p>The curves actually get further apart at first as arsenic increases (up to a point.) That is, the curves for short distances rise quite quickly as arsenic increases, while the curves for long distances rise more slowly. Eventually, for exceptionally high levels of arsenic, the curves come together (because they can't go any higher than 1.)</p>
<h2 id="lots-of-predictors">Lots of predictors</h2>
<p>Distance and arsenic are both good predictors and there's no reason to think there shouldn't be an interaction, so keep the interaction term. Now let's add <code>assoc</code> and <code>educ</code> to the model and see if the fit makes sense.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(<span class="kw">glm</span>(switch ~<span class="st"> </span>dist *<span class="st"> </span>arsenic +<span class="st"> </span>assoc +<span class="st"> </span>educ, <span class="dt">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="dt">data =</span> wells))</code></pre>
<pre><code>## 
## Call:
## glm(formula = switch ~ dist * arsenic + assoc + educ, family = &quot;binomial&quot;, 
##     data = wells)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -2.7303  -1.1892   0.7444   1.0675   1.6987  
## 
## Coefficients:
##               Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)  -0.291120   0.131427  -2.215  0.02675 *  
## dist         -0.006081   0.002093  -2.905  0.00367 ** 
## arsenic       0.553238   0.069542   7.955 1.79e-15 ***
## assoc        -0.123188   0.076977  -1.600  0.10953    
## educ          0.041948   0.009594   4.372 1.23e-05 ***
## dist:arsenic -0.001612   0.001022  -1.577  0.11482    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 4118.1  on 3019  degrees of freedom
## Residual deviance: 3905.4  on 3014  degrees of freedom
## AIC: 3917.4
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<p>Years of education has a positive coefficient, which makes sense. We can keep that in the model.</p>
<p>Association membership has a <em>negative</em> coefficient, which doesn't make causal sense: it would be strange for association membership to make you <em>less</em> likely to switch wells, unless you were a member of the Association for Arsenic Being Good for You. If our sole goal was prediction, we could do a careful cross-validation to see if association membership did help predict more accurately. Since we're doing EDA, we can drop the association term.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(<span class="kw">glm</span>(switch ~<span class="st"> </span>dist *<span class="st"> </span>arsenic +<span class="st"> </span>educ, <span class="dt">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="dt">data =</span> wells))</code></pre>
<pre><code>## 
## Call:
## glm(formula = switch ~ dist * arsenic + educ, family = &quot;binomial&quot;, 
##     data = wells)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -2.7149  -1.1886   0.7478   1.0689   1.7223  
## 
## Coefficients:
##               Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)  -0.349044   0.126360  -2.762  0.00574 ** 
## dist         -0.006047   0.002095  -2.886  0.00390 ** 
## arsenic       0.555367   0.069531   7.987 1.38e-15 ***
## educ          0.042306   0.009581   4.415 1.01e-05 ***
## dist:arsenic -0.001629   0.001023  -1.592  0.11145    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 4118.1  on 3019  degrees of freedom
## Residual deviance: 3907.9  on 3015  degrees of freedom
## AIC: 3917.9
## 
## Number of Fisher Scoring iterations: 4</code></pre>
</div>
<div class="slide section level1">

<p>We now add the remaining two-way interactions. In general, if you only have a few terms, you might as well include all the two-way interactions unless you have a good reason not to.</p>
<pre class="sourceCode r"><code class="sourceCode r">switch_model =<span class="st"> </span><span class="kw">glm</span>(switch ~<span class="st"> </span>dist +<span class="st"> </span>arsenic +<span class="st"> </span>educ +<span class="st"> </span>dist:arsenic +<span class="st"> </span>dist:educ +<span class="st"> </span>arsenic:educ,
    <span class="dt">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="dt">data =</span> wells)</code></pre>
</div>
<div class="slide section level1">

<p>At this point our model is too complicated for it to be worth trying to interpret the numbers. Let's extract the fitted values and residuals, and plot the latter against the former. Note that the default of <code>augment()</code> is to extract the deviance residuals instead of the response residuals, if you know about and prefer deviance residuals you can specify them instead.</p>
<pre class="sourceCode r"><code class="sourceCode r">switch_model_df =<span class="st"> </span><span class="kw">augment</span>(switch_model, <span class="dt">type.residuals =</span> <span class="st">&quot;response&quot;</span>)
<span class="kw">ggplot</span>(switch_model_df, <span class="kw">aes</span>(<span class="dt">x =</span> .fitted, <span class="dt">y =</span> .resid)) +
<span class="st">    </span><span class="kw">geom_point</span>() +
<span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="dt">method.args =</span> <span class="kw">list</span>(<span class="dt">degree =</span> <span class="dv">1</span>)) +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Fitted values&quot;</span>) +
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Residuals&quot;</span>)</code></pre>
<div class="figure">
<img src="lecture-22-fig/unnamed-chunk-19-1.png" />
</div>
<p>The points on the plot will always fall exactly on two lines, so look at the smooth instead. We see there's a little bit of waviness. This is fairly typical for logistic regression: there's no reason why the relationship between probability and the predictors should have that exact functional form. But the improvement in fit you get from fitting a nonparametric model is fairly small.</p>
</div>
<div class="slide section level1">

<p>Now plot the residuals against distance. What we're looking for here is whether the function form is correct, or whether we need more flexibility in how we use distance to predict switching.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(switch_model_df, <span class="kw">aes</span>(<span class="dt">x =</span> dist, <span class="dt">y =</span> .resid)) +
<span class="st">    </span><span class="kw">geom_point</span>() +
<span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="dt">method.args =</span> <span class="kw">list</span>(<span class="dt">degree =</span> <span class="dv">1</span>)) +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Distance from nearest safe well&quot;</span>) +
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Residuals&quot;</span>)</code></pre>
<div class="figure">
<img src="lecture-22-fig/unnamed-chunk-20-1.png" />
</div>
<p>There's a wiggle, but this is basically fine -- the zero line is enclosed in the confidence band.</p>
</div>
<div class="slide section level1">

<p>Now let's do the same plot with arsenic on the <span class="math">\(x\)</span>-axis:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(switch_model_df, <span class="kw">aes</span>(<span class="dt">x =</span> arsenic, <span class="dt">y =</span> .resid)) +
<span class="st">    </span><span class="kw">geom_point</span>() +
<span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="dt">method.args =</span> <span class="kw">list</span>(<span class="dt">degree =</span> <span class="dv">1</span>)) +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Arsenic concentration&quot;</span>) +
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Residuals&quot;</span>)</code></pre>
<div class="figure">
<img src="lecture-22-fig/unnamed-chunk-21-1.png" />
</div>
<p>This is much worse. The curve is too low, then rises too high, then declines again. In fact, the extreme left hand side is the biggest problem, since the lack is fit is real and the data is dense there. The negative average residual there means that for arsenic levels just over the threshold, the probability of switching is <em>overestimated</em> (negative average residuals occur when there are more zeroes in the response than the model expects.) When the residual curve becomes positive for arsenic between 1 and 2, that means the model <em>underestimates</em> the probability of switch for those arsenic values.</p>
</div>
<div class="slide section level1">

<p>Education isn't that interesting since the effect is much smaller, but let's do it for completeness.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(switch_model_df, <span class="kw">aes</span>(<span class="dt">x =</span> educ, <span class="dt">y =</span> .resid)) +
<span class="st">    </span><span class="kw">geom_point</span>() +
<span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="dt">method.args =</span> <span class="kw">list</span>(<span class="dt">degree =</span> <span class="dv">1</span>)) +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Years of education&quot;</span>) +
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Residuals&quot;</span>)</code></pre>
<div class="figure">
<img src="lecture-22-fig/unnamed-chunk-22-1.png" />
</div>
<p>Again, the fit is imperfect.</p>
</div>
<div class="slide section level1">

<p>Remember when we said we might need to transform? The last couple of graphs suggest that while a transformation of distance is unnecessary, a transformation of arsenic is. A transformation of education would probably help too, but since the variable is weird and not that important we won't bother. We'll take the log arsenic and refit the model.</p>
<pre class="sourceCode r"><code class="sourceCode r">wells$log.arsenic =<span class="st"> </span><span class="kw">log</span>(wells$arsenic)
log_arsenic_model =<span class="st"> </span><span class="kw">glm</span>(switch ~<span class="st"> </span>dist +<span class="st"> </span>log.arsenic +<span class="st"> </span>educ +<span class="st"> </span>dist:log.arsenic +<span class="st"> </span>dist:educ +<span class="st"> </span>log.arsenic:educ, <span class="dt">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="dt">data =</span> wells)
log_arsenic_model_df =<span class="st"> </span><span class="kw">augment</span>(log_arsenic_model, <span class="dt">type.residuals =</span> <span class="st">&quot;response&quot;</span>, <span class="dt">type.predict =</span> <span class="st">&quot;response&quot;</span>)</code></pre>
</div>
<div class="slide section level1">

<p>Now plot the residuals of this new model against log arsenic:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(log_arsenic_model_df, <span class="kw">aes</span>(<span class="dt">x =</span> log.arsenic, <span class="dt">y =</span> .resid)) +
<span class="st">    </span><span class="kw">geom_point</span>() +
<span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="dt">method.args =</span> <span class="kw">list</span>(<span class="dt">degree =</span> <span class="dv">1</span>))  +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Log arsenic concentration&quot;</span>) +
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Residuals&quot;</span>)</code></pre>
<div class="figure">
<img src="lecture-22-fig/unnamed-chunk-24-1.png" />
</div>
<p>It's a lot better. I'm fairly happy with the model at this point.</p>
</div>
<div class="slide section level1">

<p>Let's take a look at the fit. Fix education at its median, and draw arsenic curves for several distances:</p>
<pre class="sourceCode r"><code class="sourceCode r">switch_grid =<span class="st"> </span><span class="kw">expand.grid</span>(<span class="dt">arsenic =</span> <span class="kw">seq</span>(<span class="fl">0.5</span>, <span class="dv">10</span>, <span class="fl">0.01</span>), <span class="dt">dist =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="dv">25</span>), <span class="dt">educ =</span> <span class="dv">5</span>)
switch_grid$log.arsenic =<span class="st"> </span><span class="kw">log</span>(switch_grid$arsenic)
log_arsenic_pred_grid =<span class="st"> </span><span class="kw">augment</span>(log_arsenic_model, <span class="dt">newdata =</span> switch_grid,
    <span class="dt">type.predict =</span> <span class="st">&quot;response&quot;</span>, <span class="dt">type.residuals =</span> <span class="st">&quot;response&quot;</span>)
<span class="kw">ggplot</span>(log_arsenic_pred_grid, <span class="kw">aes</span>(<span class="dt">x =</span> arsenic, <span class="dt">y =</span> .fitted, <span class="dt">group =</span> dist, <span class="dt">color =</span> dist)) +
<span class="st">    </span><span class="kw">geom_line</span>() +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Arsenic concentration&quot;</span>) +
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Probability of switching&quot;</span>) +<span class="st"> </span><span class="kw">scale_color_viridis</span>()</code></pre>
<div class="figure">
<img src="lecture-22-fig/unnamed-chunk-25-1.png" />
</div>
</div>
<div class="slide section level1">

<p>There are 3! ways you can assign the three variables to <span class="math">\(x\)</span>-axis, conditioning variable, and fixed. You probably get the idea at this point, though, so let's just do one more:</p>
<pre class="sourceCode r"><code class="sourceCode r">switch_grid_2 =<span class="st"> </span><span class="kw">expand.grid</span>(<span class="dt">arsenic =</span> <span class="kw">seq</span>(<span class="fl">0.5</span>, <span class="dv">10</span>, <span class="fl">0.01</span>), <span class="dt">dist =</span> <span class="kw">median</span>(wells$dist), <span class="dt">educ =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>))
switch_grid_2$log.arsenic =<span class="st"> </span><span class="kw">log</span>(switch_grid_2$arsenic)
log_arsenic_pred_grid_2 =<span class="st"> </span><span class="kw">augment</span>(log_arsenic_model, <span class="dt">newdata =</span> switch_grid_2,
    <span class="dt">type.predict =</span> <span class="st">&quot;response&quot;</span>, <span class="dt">type.residuals =</span> <span class="st">&quot;response&quot;</span>)
<span class="kw">ggplot</span>(log_arsenic_pred_grid_2,
       <span class="kw">aes</span>(<span class="dt">x =</span> arsenic, <span class="dt">y =</span> .fitted, <span class="dt">group =</span> educ, <span class="dt">color =</span> <span class="kw">factor</span>(educ))) +
<span class="st">    </span><span class="kw">geom_line</span>() +
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Arsenic concentration&quot;</span>) +
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Probability of switching&quot;</span>) +
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">color =</span> <span class="st">&quot;Education&quot;</span>) +
<span class="st">    </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#999999&quot;</span>, <span class="st">&quot;#E69F00&quot;</span>, <span class="st">&quot;#56B4E9&quot;</span>),
                       <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;0 years&quot;</span>, <span class="st">&quot;5 years&quot;</span>, <span class="st">&quot;10 years&quot;</span>))</code></pre>
<div class="figure">
<img src="lecture-22-fig/unnamed-chunk-26-1.png" />
</div>
</div>
<div id="improving-the-model" class="slide section level1">
<h1>Improving the model</h1>
<p>If you really care about prediction but still want to be able to interpret the model, try a nonparametric model such as a generalized additive model (GAM) or loess. To overgeneralize, GAM is often better/easier when you have lots of predictors, while loess is often better/easier when you have complex interactions. You can learn more about these in S425/625.</p>
<p>If you really, really care about predictions then you can use machine learning techniques. The improvement in prediction is usually quite small, however, and you'll lose a lot or all the interpretability.</p>
</div>
</body>
</html>
